---
title: "Breed-specific ssGBLUP, GWAS, and meta-analysis"
author: "Harly Durbin"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(readr)
library(tidyr)
library(stringr)
library(dplyr)
library(ggplot2)
library(glue)
library(readxl)
library(magrittr)
library(tidylog)
library(rlang)

source(here::here("source_functions/melt_aireml.R"))
source(here::here("source_functions/calculate_heritability.R"))
source(here::here("source_functions/hair_manhattan.R"))
source(here::here("source_functions/ggqq.R"))

options(scipen = 999)
```

# Notes & questions

[Miller Stone map colors](https://jrnold.github.io/ggthemes/reference/tableau_color_pal.html)

* Angus: Blues ("#4f6980", "#849db1")
* IGS/Simmental: Dark greens ("#638b66", "#a2ceaa")
* Hereford: Orange/yellow ("#f47942", "#fbb04e")
* Brangus: Light greens ("#bfbb60", "#d7ce9f")

## Datasets

* Hereford
* Participating IGS breed associations
    + RAN, SIM, GEL, SH, CHI
* Brangus
* Angus
    
```{r, eval=FALSE}
scales::show_col(bakeoff::bakeoff_pal()(11))
```
    
# Setup

```{r}
breed_key <- 
  read_rds(here::here("data/derived_data/breed_key/breed_key.rds"))
```

## Raw GWAS results

### SNP1101

```{r, warning=FALSE, message=FALSE}
breeds_snp1101 <-
  c("hfd1", "an1", "bg1", "igs1") %>% 
  purrr::set_names() %>% 
  purrr::map_dfr(~ read_table2(here::here(glue("data/derived_data/snp1101/{.x}/out/gwas_ssr_{.x}_bvs_p.txt")))  %>%
                   janitor::clean_names() %>%
                   mutate(neglog10p = -log10(p_value),
                          neglog10q = -log10(qvalue::qvalue(p_value)$qvalues)) %>%
                   left_join(read_table2(here::here(glue("data/derived_data/snp1101/{.x}/out/gwas_ssr_{.x}_bvs.txt")),
                                         skip = 12) %>%
                               select(chr = Chr, pos = Pos, fdr = FDR_GW, a)),
                 .id = "dataset")
```



### GCTA

```{r, eval = FALSE}
breeds_gcta <-
  c("hfd1", "an1", "bg1", "igs1") %>% 
  purrr::set_names() %>% 
  purrr::map_dfr(~ read_table2(here::here(glue("data/derived_data/gcta_gwas/{.x}/{.x}.mlma"))) %>% 
                   janitor::clean_names() %>% 
                   mutate(neglog10p = -log10(p),
                          neglog10q = -log10(qvalue::qvalue(p)$qvalues)),
                 .id = "dataset") %>% 
  rename(pos = bp)

```

## `METASOFT` input file

```{r, warning=FALSE, message=FALSE, eval=FALSE}

purrr::map2(.x = c("an1", "bg1", "hfd1", "igs1"),
            .y = c(3079, 882, 1009, 4375),
            ~ breeds_snp1101 %>% 
              filter(dataset == .x) %>% 
              mutate(id = glue("{chr}:{pos}"),
                     #se = sqrt(var/.y),
                     se = var) %>%
              select(id, !!rlang::sym(glue("{.x}_b")) := b_value, !!rlang::sym(glue("{.x}_se")) := se)) %>% 
  purrr::reduce(left_join) %>% 
  mutate_if(is.numeric, ~ if_else(. == 0, na_dbl, .)) %>% 
  write_tsv(here::here("data/derived_data/metasoft/breeds/metasoft_in.breeds.var.txt"),
            col_names = FALSE)
```

```
srun java -jar source_functions/Metasoft/Metasoft.jar -pvalue_table source_functions/Metasoft/HanEskinPvalueTable.txt -input data/derived_data/metasoft/breeds/metasoft_in.breeds.var.txt -output data/derived_data/metasoft/breeds/metasoft_out.breeds.var.txt -mvalue -mvalue_p_thres 0.01 -log data/derived_data/metasoft/breeds/metasoft.breeds.var.log
```
```
srun java -jar source_functions/Metasoft/Metasoft.jar -pvalue_table source_functions/Metasoft/HanEskinPvalueTable.txt -input data/derived_data/metasoft/breeds/metasoft_in.breeds.txt -output data/derived_data/metasoft/breeds/metasoft_out.breeds_corrected.var.txt -mvalue -mvalue_p_thres 0.01 -log data/derived_data/metasoft/breeds/metasoft.breeds_corrected.var.log -lambda_mean 185496.070770 -lambda_hetero 68271.065091
```

# Heritability and repeatability

```{r, warning=FALSE, message=FALSE}
purrr::map2_dfr(.x = c("hfd1", "an1", "bg1", "igs1"),
                .y = c("Hereford", "Angus", "Brangus", "IGS breeds"),
                ~ read_table2(here::here(glue("data/derived_data/aireml_varcomp/{.x}/data.txt")),
                              col_names = FALSE) %>% 
                  summarise(`n phenotypes` = n(),
                            `n phenotyped animals` = n_distinct(X1),
                            key = .y)) %>% 
  left_join(purrr::map2_dfr(.x = c("hfd1", "an1", "bg1", "igs1"),
                            .y = c("Hereford", "Angus", "Brangus", "IGS breeds"),
                            ~ read_table2(here::here(glue("data/derived_data/aireml_varcomp/{.x}/pull_list.txt")),
                                          col_names = FALSE) %>% 
                              summarise(`n genotyped` = n(),
                                        key = .y))) %>% 
  mutate_if(is.numeric, ~ scales::comma(.)) %>% 
  select(key, everything()) 
```

```{r, warning = FALSE, message = FALSE}
breed_h2 <-
  purrr::map2_dfr(.x = c("hfd1", "an1", "bg1", "igs1", "fixed9"),
                  .y = c("Hereford", "Angus", "Brangus", "IGS breeds", "Full dataset"),
                  ~ melt_aireml(path = here::here(glue("data/derived_data/aireml_varcomp/{.x}/airemlf90.{.x}.log")),
                                effect2 = c("hair_dir"),
                                effect3 = c("hair_pe"),
                                resids = c("hair_res")) %>% 
                    univ_heritability(abbrv = "hair",
                                      desc = .y,
                                      pe = TRUE))

```

```{r}
breed_h2 %>% 
  left_join(purrr::map2_dfr(.x = c("hfd1", "an1", "bg1", "igs1", "fixed9"),
                            .y = c("Hereford", "Angus", "Brangus", "IGS breeds", "Full dataset"),
                            ~ melt_aireml(path = here::here(glue("data/derived_data/aireml_varcomp/{.x}/airemlf90.{.x}.log")),
                                          effect2 = c("hair_dir"),
                                          effect3 = c("hair_pe"),
                                          resids = c("hair_res")) %>% 
                              mutate(key = .y)) %>% 
              filter(val1 == val2) %>% 
              select(-val1) %>% 
              tidyr::pivot_wider(values_from = var_cov,
                                 names_from = val2,
                                 id_cols = key)) %>% 
  select(key, `Direct var.` = hair_dir, `PE var.` = hair_pe, `Residual var.` = hair_res, `Direct h2`, Repeatability) %>% 
  add_row(key = "AGI dataset", `Direct var.` = 0.37679, `PE var.` = 0.039171, `Residual var.` = 0.53274, `Direct h2` = 0.40, Repeatability = 0.44)
```

# GWAS

```{r}
breeds_snp1101 %>% 
  filter(neglog10p > 5) %>% 
  group_by(dataset) %>% 
  tally()
```

```{r}
breeds_snp1101 %>% 
  filter(neglog10p > 5) %>% 
  group_by(chr, pos) %>% 
  tally() %>% 
  filter(n > 1)
```

## Hereford

### SNP1101

```{r, fig.width = 11, fig.height = 6.16}
hair_manhattan(df = breeds_snp1101 %>% 
                 filter(dataset == "hfd1") %>% 
                 filter(0.01 > p_value),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "#f47942",
               color2 = "#fbb04e")

ggsave(filename = here::here("figures/breeds/hfd1_snp1101.q.png"), height = 6.16, width = 11)
```

```{r, fig.width = 11, fig.height = 6.16}
hair_manhattan(df = breeds_snp1101 %>% 
                 filter(dataset == "hfd1") %>% 
                 filter(0.01 > p_value),
               y_var = neglog10p, 
               y_lab = "-log10(p-value)",
               sigline = 5,
               color1 = "#f47942",
               color2 = "#fbb04e")
#("#f47942", "#fbb04e")
ggsave(filename = here::here("figures/breeds/hfd1_snp1101.p.png"), height = 6.16, width = 11)
```

```{r}
ggqq(pvector = breeds_snp1101[breeds_snp1101$dataset == "hfd1", "p_value"][[1]])

ggsave(here::here("figures/breeds/hfd1_snp1101.Q-Q.png"))
```


### GCTA

```{r, fig.width = 11, fig.height = 6.16, eval = FALSE}
hair_manhattan(df = breeds_gcta %>% 
                 filter(dataset == "hfd1") %>% 
                 filter(0.01 > p),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "gray1",
               color2 = "gray91")


```

## Angus

### SNP1101

```{r, fig.width = 11, fig.height = 6.16}
hair_manhattan(df = breeds_snp1101 %>% 
                 filter(dataset == "an1") %>% 
                 filter(0.01 > p_value),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "#4f6980",
               color2 = "#849db1")

#("#4f6980", "#849db1")

ggsave(filename = here::here("figures/breeds/an1_snp1101.q.png"), height = 6.16, width = 11)
```

```{r, fig.width = 11, fig.height = 6.16}
hair_manhattan(df = breeds_snp1101 %>% 
                 filter(dataset == "an1") %>% 
                 filter(0.01 > p_value),
               y_var = neglog10p, 
               y_lab = "-log10(p-value)",
               sigline = 5,
               color1 = "#4f6980",
               color2 = "#849db1")

#("#4f6980", "#849db1")

ggsave(filename = here::here("figures/breeds/an1_snp1101.p.png"), height = 6.16, width = 11)
```

```{r}
ggqq(pvector = breeds_snp1101[breeds_snp1101$dataset == "an1", "p_value"][[1]])

ggsave(here::here("figures/breeds/an1_snp1101.Q-Q.png"))
```

### GCTA

```{r, fig.width = 11, fig.height = 6.16, eval = FALSE}
hair_manhattan(df = breeds_gcta %>% 
                 filter(dataset == "an1") %>% 
                 filter(0.01 > p),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "gray1",
               color2 = "gray91")
```

```{r, eval=FALSE}
ggqq(pvector = breeds_gcta[breeds_gcta$dataset == "an1", "p"][[1]])

ggsave(here::here("figures/breeds/an1_gcta.Q-Q.png"))
```

## IGS

### SNP1101

```{r, fig.width = 11, fig.height = 6.16}
hair_manhattan(df = breeds_snp1101 %>% 
                 filter(dataset == "igs1") %>% 
                 filter(0.01 > p_value),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "#638b66",
               color2 = "#a2ceaa")
#("#638b66", "#a2ceaa")
ggsave(filename = here::here("figures/breeds/igs1_snp1101.q.png"), height = 6.16, width = 11)
```

```{r, fig.width = 11, fig.height = 6.16}
hair_manhattan(df = breeds_snp1101 %>% 
                 filter(dataset == "igs1") %>% 
                 filter(0.01 > p_value),
               y_var = neglog10p, 
               y_lab = "-log10(p-value)",
               sigline = 5,
               color1 = "#638b66",
               color2 = "#a2ceaa")
#("#638b66", "#a2ceaa")
ggsave(filename = here::here("figures/breeds/igs1_snp1101.p.png"), height = 6.16, width = 11)
```

```{r}
ggqq(pvector = breeds_snp1101[breeds_snp1101$dataset == "igs1", "p_value"][[1]])

ggsave(here::here("figures/breeds/igs1_snp1101.Q-Q.png"))
```

### GCTA

```{r, fig.width = 11, fig.height = 6.16, eval = FALSE}
hair_manhattan(df = breeds_gcta %>% 
                 filter(dataset == "igs1") %>% 
                 filter(0.01 > p),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "gray1",
               color2 = "gray91")
```

## Brangus

### SNP1101

```{r, fig.width = 11, fig.height = 6.16}
hair_manhattan(df = breeds_snp1101 %>% 
                 filter(dataset == "bg1") %>% 
                 filter(0.01 > p_value),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "#bfbb60",
               color2 = "#d7ce9f")
#"#bfbb60", "#d7ce9f"
ggsave(filename = here::here("figures/breeds/bg11_snp1101.q.png"), height = 6.16, width = 11)
```

```{r, fig.width = 11, fig.height = 6.16}
hair_manhattan(df = breeds_snp1101 %>% 
                 filter(dataset == "bg1") %>% 
                 filter(0.01 > p_value),
               y_var = neglog10p, 
               y_lab = "-log10(p-value)",
               sigline = 5,
               color1 = "#bfbb60",
               color2 = "#d7ce9f")

ggsave(filename = here::here("figures/breeds/bg1_snp1101.p.png"), height = 6.16, width = 11)
```

```{r}
ggqq(pvector = breeds_snp1101[breeds_snp1101$dataset == "bg1", "p_value"][[1]])

ggsave(here::here("figures/breeds/bg1_snp1101.Q-Q.png"))
```

### GCTA

```{r, fig.width = 11, fig.height = 6.16, eval=FALSE}
hair_manhattan(df = breeds_gcta %>% 
                 filter(dataset == "bg1") %>% 
                 filter(0.01 > p),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "gray1",
               color2 = "gray91")
```

# Multi-panel breeds Manhattan plot

```{r}
overlap <-
  breeds_snp1101 %>% 
  filter(neglog10p >= 5) %>% 
  group_by(chr, pos) %>% 
  filter(n() > 1) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  left_join(breeds_snp1101) %>% 
  mutate(chr_color = "black")

```

```{r, fig.width=6, fig.height=12}
practice <-
  breeds_snp1101 %>% 
  filter(0.9 >= p_value) %>% 
  chr_len() %>% 
  full_join(overlap) %>% 
  mutate(chr_color = case_when(!is.na(chr_color) ~ chr_color,
                               dataset == "an1" & chr %in% c(seq(from = 1,
                                                                 to = 29,
                                                                 by = 2)) ~ "#4f6980",
                               dataset == "an1" & chr %in% c(seq(from = 2,
                                                                 to = 29,
                                                                 by = 2)) ~ "#849db1",
                               dataset == "bg1" & chr %in% c(seq(from = 1,
                                                                 to = 29,
                                                                 by = 2)) ~ "#bfbb60",
                               dataset == "bg1" & chr %in% c(seq(from = 2,
                                                                 to = 29,
                                                                 by = 2)) ~ "#d7ce9f",
                               dataset == "hfd1" & chr %in% c(seq(from = 1,
                                                                 to = 29,
                                                                 by = 2)) ~ "#f47942",
                               dataset == "hfd1" & chr %in% c(seq(from = 2,
                                                                 to = 29,
                                                                 by = 2)) ~ "#fbb04e",
                               dataset == "igs1" & chr %in% c(seq(from = 1,
                                                                 to = 29,
                                                                 by = 2)) ~ "#638b66",
                               dataset == "igs1" & chr %in% c(seq(from = 2,
                                                                 to = 29,
                                                                 by = 2)) ~ "#a2ceaa"),
         dataset = case_when(dataset == "an1" ~ "AN (n = 3,268)",
                             dataset == "bg1" ~ "BG (n = 883)",
                             dataset == "hfd1" ~ "HFD (n = 1,055)",
                             dataset == "igs1" ~ "IGS (n = 4,722)"))
```

```{r}
axisdf <-
  practice %>%
  group_by(chr) %>%
  summarize(center = (max(BPcum) + min(BPcum)) / 2) 
```

```{r, fig.width=9, fig.height=12}
ggplot(practice) +
  geom_point(aes(x = BPcum,
                 y = neglog10p,
                 color = chr_color,
                 fill = chr_color),
                 alpha = 0.75) +
  scale_color_identity() +
  geom_point(data = base::subset(practice, chr_color == 'black'),
             aes(x = BPcum,
                 y = neglog10p,
                 color = "black"),
             alpha = 1) +
  scale_fill_identity() +
  scale_x_continuous(label = axisdf$chr[c(TRUE, FALSE)],
                     breaks = axisdf$center[c(TRUE, FALSE)]) +
  theme_classic() +
  theme(plot.title = element_text(size = 24,
                                  face = "italic",
                                  margin = margin(t = 0,
                                                  r = 0,
                                                  b = 13,
                                                  l = 0)),
        plot.subtitle = element_text(size = 20,
                                     face = "italic",
                                     margin = margin(t = 0,
                                                     r = 0,
                                                     b = 13,
                                                     l = 0)),
        axis.title = element_text(size = 18),
        axis.title.y = element_text(margin = margin(t = 0,
                                                    r = 13,
                                                    b = 0,
                                                    l = 0)),
        axis.title.x = element_text(margin = margin(t = 13,
                                                    r = 0,
                                                    b = 0,
                                                    l = 0)),
        axis.text = element_text(size = 14),
        legend.text = element_text(size = 14),
        strip.text = element_text(size = 14)) +
  geom_hline(yintercept = 5,
             color = "red",
             size = 0.25) +
  labs(x = NULL,
       y = latex2exp::TeX("$-log_{10}(p-value)$")) +
  facet_wrap(~ dataset,
             nrow = 4)
```

```{r}
ggsave(here::here("figures/breeds/an1bg1hfd1igs1_snp1101.p.png"), width = 9, height = 12)
```


# `METASOFT`

RSID, #STUDY, PVALUE_FE, BETA_FE, STD_FE, PVALUE_RE, BETA_RE, STD_RE, PVALUE_RE2, STAT1_RE2, STAT2_RE2, PVALUE_BE, I_SQUARE, Q, PVALUE_Q, TAU_SQUARE
1:530998, 4, 0.00000, -0.0304635, 0.000336349, 0.254139, 0.0315562, 0.0276723, 0.00000, 8203.13, 14111.9, NA, 99.9788, 14151.4, 0.00000, 0.00306030

```{r, eval=FALSE}
breeds_metasoft <- 
  read_table2(here::here("data/derived_data/metasoft/breeds/metasoft_out.breeds.txt"),
              col_types = cols(.default = "d", RSID = "c")) %>% 
  janitor::clean_names() %>% 
  select(-pvalues_of_studies_tab_delimitered, -mvalues_of_studies_tab_delimitered, -pvalue_be) %>% 
  left_join(read_table2(here::here("data/derived_data/metasoft/breeds/metasoft_out.breeds.txt"),
                        skip = 1,
                        col_types = "c---------------dddddddd", 
                        col_names = c("rsid", "an1p", "bg1p", "hfd1p", "igs1p", "an1m", "bg1m", "hfd1m", "igs1m")))

```

```{r}
breeds_metasoft %<>% 
  mutate_at(vars(ends_with("1m")), ~ if_else(is.nan(.), na_dbl, .)) %>% 
  filter_at(vars(ends_with("1m")), any_vars(!is.na(.))) %>% 
  select(-contains("fe"), -pvalue_re, -beta_re, -std_re) %>% 
  mutate(neglog10re2 = -log10(pvalue_re2))
```

```{r}
breeds_metasoft %<>%
  mutate(neglog10qp = -log10(pvalue_q)) %>% 
  select(rsid, number_study, stat1_re2, stat2_re2, neglog10re2, q, neglog10qp, tau_square:igs1m, everything())
```

```{r}
breeds_metasoft %>% 
  filter(neglog10re2 >= 5)
  
  arrange(q)
```

```{r}
breeds_metasoft %>% 
  filter_at(vars(ends_with("1m")), any_vars(. > 0 & 1 > .))
```

