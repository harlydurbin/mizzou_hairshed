---
title: "Breed-specific ssGBLUP, GWAS, and meta-analysis"
author: "Harly Durbin"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(readr)
library(tidyr)
library(stringr)
library(dplyr)
library(glue)
library(readxl)
library(magrittr)
library(tidylog)

source(here::here("source_functions/melt_aireml.R"))
source(here::here("source_functions/calculate_heritability.R"))

options(scipen = 999)
```

# Notes & questions

## Datasets

* Hereford
* Participating IGS breed associations
    + RAN, SIM, GEL, SH, CHI
* Brangus
* Angus
    
# Setup

```{r, warning=FALSE, message=FALSE}
cleaned <- read_rds(here::here("data/derived_data/import_join_clean/cleaned.rds"))
```

```{r}
full_ped <- read_rds(here::here("data/derived_data/3gen/full_ped.rds"))
```

```{r}
breed_key <- read_rds(here::here("data/derived_data/breed_key/breed_key.rds"))
```

# Heritability and repeatability

```{r}
purrr::map2_dfr(.x = c("hfd1", "an1", "bg1", "igs1"),
                .y = c("Hereford", "Angus", "Brangus", "IGS breeds"),
                ~ read_table2(here::here(glue("data/derived_data/aireml_varcomp/{.x}/data.txt")),
                              col_names = FALSE) %>% 
                  summarise(`n phenotypes` = n(),
                            `n phenotyped animals` = n_distinct(X1),
                            key = .y)) %>% 
  left_join(purrr::map2_dfr(.x = c("hfd1", "an1", "bg1", "igs1"),
                            .y = c("Hereford", "Angus", "Brangus", "IGS breeds"),
                            ~ read_table2(here::here(glue("data/derived_data/aireml_varcomp/{.x}/pull_list.txt")),
                                          col_names = FALSE) %>% 
                              summarise(`n genotyped` = n(),
                                        key = .y))) %>% 
  mutate_if(is.numeric, ~ scales::comma(.)) %>% 
  select(key, everything()) 
```

```{r, warning = FALSE, message = FALSE}
breed_h2 <-
  purrr::map2_dfr(.x = c("hfd1", "an1", "bg1", "igs1", "fixed9"),
                  .y = c("Hereford", "Angus", "Brangus", "IGS breeds", "Full dataset"),
                  ~ melt_aireml(path = here::here(glue("data/derived_data/aireml_varcomp/{.x}/airemlf90.{.x}.log")),
                                effect2 = c("hair_dir"),
                                effect3 = c("hair_pe"),
                                resids = c("hair_res")) %>% 
                    univ_heritability(abbrv = "hair",
                                      desc = .y,
                                      pe = TRUE))

```

```{r}
breed_h2 %>% 
  left_join(purrr::map2_dfr(.x = c("hfd1", "an1", "bg1", "igs1", "fixed9"),
                            .y = c("Hereford", "Angus", "Brangus", "IGS breeds", "Full dataset"),
                            ~ melt_aireml(path = here::here(glue("data/derived_data/aireml_varcomp/{.x}/airemlf90.{.x}.log")),
                                          effect2 = c("hair_dir"),
                                          effect3 = c("hair_pe"),
                                          resids = c("hair_res")) %>% 
                              mutate(key = .y)) %>% 
              filter(val1 == val2) %>% 
              select(-val1) %>% 
              tidyr::pivot_wider(values_from = var_cov,
                                 names_from = val2,
                                 id_cols = key)) %>% 
  select(key, `Direct var.` = hair_dir, `PE var.` = hair_pe, `Residual var.` = hair_res, `Direct h2`, Repeatability) %>% 
  add_row(key = "AGI dataset", `Direct var.` = 0.37679, `PE var.` = 0.039171, `Residual var.` = 0.53274, `Direct h2` = 0.40, Repeatability = 0.44)
```
