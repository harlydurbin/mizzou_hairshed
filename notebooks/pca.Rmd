---
title: "PCA"
author: "Harly Durbin"
output:
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(readr)
library(magrittr)
library(purrr)
library(dplyr)
library(stringr)
library(ggplot2)

source(here::here("source_functions/plot_pca.R"))
```

# Notes & questions

# Setup

```{r}
breed_key <- read_rds(here::here("data/derived_data/breed_key/breed_key.rds"))
```

```{r}
vec <-
  read_table2(here::here("data/derived_data/smartpca/smartpca.mizzou_hairshed.evec"),
              skip = 1,
              col_names = FALSE) %>%
  select(-X12) %>%
  set_names(c("full_reg", map_chr(1:10, ~ str_c("PC", .x)))) %>% 
  mutate(full_reg = str_extract(full_reg, "(?<=[[:alnum:]]:)[[:alnum:]]+$")) %>% 
  left_join(breed_key) %>% 
  mutate(cross = case_when(is.na(cross) ~ str_extract(full_reg, "^[[:upper:]]{3}"),
                           TRUE ~ cross),
         cross = case_when(cross == "AAA" ~ "AN",
                           cross == "GVH" ~ "GEL",
                           cross == "BSH" ~ "SH",
                           cross == "HER" ~ "HFD",
                           TRUE ~ cross)) 
```

```{r}
  val <-
    read_lines(here::here("data/derived_data/smartpca/smartpca.mizzou_hairshed.evec"),
               n_max = 1) %>%
      str_remove("#eigvals:") %>%
      str_squish() %>%
      str_split(pattern = "[[:space:]]") %>%
      flatten_chr() %>%
      map_dbl( ~ as.numeric(.x))
```


# Plot

```{r, fig.width = 7, fig.height=5}
vec %>%
  ggplot(aes(x = PC1,
             y = PC2)) +
  geom_point(aes(color = cross),
             alpha = 0.6) +
  bakeoff::scale_color_bakeoff() +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  theme_classic() +
  labs(x = str_c("PC 1: ", scales::percent(val[1] / sum(val))),
       y = str_c("PC 2: ", scales::percent(val[2] / sum(val))),
       color = str_wrap("Reported or inferred breed",
                        width = 15))
```

