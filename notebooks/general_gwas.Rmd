---
title: "General model GWAS using SNP1101"
author: "Harly Durbin"
output:
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(readr)
library(dplyr)
library(ggplot2)
library(purrr)
library(patchwork)
library(magrittr)
library(stringr)
library(tidylog)

source(here::here("source_functions/hair_manhattan.R"))
source(here::here("source_functions/ggqq.R"))
source(here::here("source_functions/parse_loglik.R"))
source(here::here("source_functions/lrt_calc.R"))
```

# Notes & questions

* Column names in *_bvs.txt file: SNPID, Chr, Pos, freq, g0, g1, g2, a, b, Var, F, p-value, FDR_GW
* Column names in *_bvs_p.txt file: Chr, Pos, freq, b-value, Var, p-value
* `b` and `b-value` are the same, assuming SNP effect? 
* Guessing g0, g1, g2 are number of individuals with genotypes 0, 1, 2
* What is F?
* What is a?

*_bvs.txt
Chr     Pos     freq    b-value Var     p-value
1       530998  0.4526  -0.052163       0.00134825      0.146002

*_bvs_p.txt
SNPID   Chr     Pos     freq    g0      g1      g2      a       b       Var     F       p-value FDR_GW
1       1       530998  0.4526  946     1479    654     0.0175772       -0.052163       0.00134825      2.1146  0.146002        -1

# Setup

## SNP1101 results

```{r, warning = FALSE, message=FALSE}
fixed9_snp1101 <-
  read_table2(here::here("data/derived_data/snp1101/fixed9/out/gwas_ssr_fixed9_bvs_p.txt"))  %>%
  janitor::clean_names() %>%
  mutate(neglog10p = -log10(p_value),
         abs_snp = abs(b_value),
         neglog10q = -log10(qvalue::qvalue(p_value)$qvalues)) %>%
  left_join(read_table2(here::here("data/derived_data/snp1101/fixed9/out/gwas_ssr_fixed9_bvs.txt"),
                        skip = 12) %>%
              select(chr = Chr, pos = Pos, fdr = FDR_GW, a))
  
```

```{r, warning = FALSE, message=FALSE}
fixed15_snp1101 <-
  read_table2(here::here("data/derived_data/snp1101/fixed15/out/gwas_ssr_fixed15_bvs_p.txt"))  %>%
  janitor::clean_names() %>%
  mutate(neglog10p = -log10(p_value),
         abs_snp = abs(b_value),
         neglog10q = -log10(qvalue::qvalue(p_value)$qvalues)) %>%
  left_join(read_table2(here::here("data/derived_data/snp1101/fixed15/out/gwas_ssr_fixed15_bvs.txt"),
                        skip = 12) %>%
              select(chr = Chr, pos = Pos, fdr = FDR_GW, a))
  
```

```{r}
max(fixed9_snp1101$neglog10q)

min(fixed9_snp1101$neglog10q)
```

```{r}
max(fixed15_snp1101$neglog10q)
```

## GCTA results
 
```{r, eval=FALSE}
fixed9_gcta <- 
  read_table2(here::here("data/derived_data/gcta_gwas/fixed9/fixed9.mlma")) %>% 
  janitor::clean_names() %>% 
  mutate(neglog10p = -log10(p),
         neglog10q = -log10(qvalue::qvalue(p)$qvalues)) %>% 
  rename(pos = bp)
```

```{r, eval = FALSE}
fixed15_gcta <-
  read_table2(here::here("data/derived_data/gcta_gwas/fixed15/fixed15.mlma")) %>% 
  janitor::clean_names() %>% 
  mutate(neglog10p = -log10(p),
         neglog10q = -log10(qvalue::qvalue(p)$qvalues)) %>% 
  rename(pos = bp)
```

# Does including first two PCs as fixed effect in the ssGBLUP model provide a better fit?

* Issue: only included phenotypes for genotyped animals in `fixed15` model (can't have missing covariates in BLUPF90), so it isn't really an equal comparison to `fixed9` model. Compare instead to `fixed14` model, which only includes phenotypes for genotyped animals

```{r}
lrt_calc(ll_null = parse_loglik(path = here::here("data/derived_data/aireml_varcomp/fixed14/airemlf90.fixed14.log"),
                                option = "logL"),
         ll_test = parse_loglik(path = here::here("data/derived_data/aireml_varcomp/fixed15/airemlf90.fixed15.log"),
                                option = "logL"))
```

# Manhattan plot of $-log_{10}(q-value)$

## SNP1101

### Without PC correction

```{r, fig.width = 11, fig.height = 6.16}

hair_manhattan(df = fixed9_snp1101 %>% 
                 filter(0.01 > p_value),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "#b9aa97",
               color2 = "#7e756d") +
  ylim(0, 15)


ggsave(filename = here::here("figures/general_gwas/fixed9_snp1101.q.png"), height = 6.16, width = 11)
```

```{r, fig.width = 11, fig.height = 6.16}

hair_manhattan(df = fixed9_snp1101 %>% 
                 filter(0.01 > p_value),
               y_var = neglog10p, 
               y_lab = "-log10(p-value)",
               sigline = 5,
               color1 = "#b9aa97",
               color2 = "#7e756d") +
  ylim(0, 20)


ggsave(filename = here::here("figures/general_gwas/fixed9_snp1101.p.png"), height = 6.16, width = 11)
```

### With PC correction

```{r, fig.width = 11, fig.height = 6.16}

hair_manhattan(df = fixed15_snp1101 %>% 
                 filter(0.01 > p_value),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "#b9aa97",
               color2 = "#7e756d") +
  ylim(0, 15)


ggsave(filename = here::here("figures/general_gwas/fixed15_snp1101.q.png"), height = 6.16, width = 11)
```

```{r, fig.width = 11, fig.height = 6.16}

hair_manhattan(df = fixed15_snp1101 %>% 
                 filter(0.01 > p_value),
               y_var = neglog10p, 
               y_lab = "-log10(p-value)",
               sigline = 5,
               color1 = "#b9aa97",
               color2 = "#7e756d") +
  ylim(0, 20)


ggsave(filename = here::here("figures/general_gwas/fixed15_snp1101.p.png"), height = 6.16, width = 11)
```

## GCTA

### Without PC correction

```{r, fig.width = 11, fig.height = 6.16,eval=FALSE}
hair_manhattan(df = fixed9_gcta %>% 
                 filter(0.01 > p),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "#ef8759",
               color2 = "#5da19a")

ggsave(here::here("figures/general_gwas/fixed9_gcta.q.png"))
```

### With PC correction

```{r, fig.width = 11, fig.height = 6.16, eval = FALSE}
hair_manhattan(df = fixed15_gcta %>% 
                 filter(0.01 > p),
               y_var = neglog10q, 
               y_lab = "-log10(q-value)",
               sigline = 1,
               color1 = "#ef8759",
               color2 = "#5da19a")

ggsave(here::here("figures/general_gwas/fixed15_gcta.q.png"))
```

# QQ plot

## SNP1101

### All SNPs

#### Without PCs

```{r}
ggqq(pvector = fixed9_snp1101$p_value)

ggsave(here::here("figures/general_gwas/fixed9_snp1101.Q-Q.png"))
```

#### With PCs

```{r}
ggqq(pvector = fixed15_snp1101$p_value)

ggsave(here::here("figures/general_gwas/fixed15_snp1101.Q-Q.png"))
```

### Non-significant SNPs

```{r}
ggqq(pvector = fixed9_snp1101[fixed9_snp1101$fdr == -1, "p_value"][[1]])

ggsave(here::here("figures/general_gwas/fixed9_snp1101.Q-Q.nonsig.png"))
```

## GCTA

### Without PC correction

```{r, eval = FALSE}
ggqq(pvector = fixed9_gcta$p) +
  theme_classic()

ggsave(here::here("figures/general_gwas/fixed9_gcta.Q-Q.png"))
```

### With PC correction

```{r, eval = FALSE}
ggqq(pvector = fixed15_gcta$p)

ggsave(here::here("figures/general_gwas/fixed15_gcta.Q-Q.png"))
```