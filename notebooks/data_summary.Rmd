---
title: "Data summary"
author: "Harly Durbin"
output:
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
```

# Setup

```{r}
cleaned <- read_rds(here::here("data/derived_data/import_join_clean/cleaned.rds"))
```

```{r}
animal_table <- read_rds(here::here("data/raw_data/import_join_clean/animal_table.rds"))
```

```{r}
bvs <- 
  read_table2(here::here("data/derived_data/aireml_varcomp/fixed9/solutions"),
              skip = 1,
              col_names = c("trait", "effect", "id_renamed", "solution", "se")) %>% 
  filter(effect == 2) %>% 
  left_join(read_table2(here::here("data/derived_data/aireml_varcomp/fixed9/renadd02.ped"),
                        col_names = FALSE) %>% 
              select(id_renamed = X1, full_reg = X10)) %>% 
  select(-trait, -effect, -id_renamed)
```

```{r}
cleaned %>% 
  visdat::vis_miss()
```

# Total number of individuals

```{r}
cleaned %>% 
  distinct(farm_id, temp_id)
```

# Tally by sex

## Number of individuals

```{r}
cleaned %>% 
  distinct(farm_id, temp_id, sex) %>% 
  group_by(sex) %>% 
  tally()
```

## Number of scores

```{r}
cleaned %>% 
  group_by(sex) %>% 
  tally()
```

# Tally by age

```{r}
cleaned %>% 
  group_by(age) %>% 
  tally()
  
```

# Tally by year

```{r}
cleaned %>% 
  group_by(year) %>% 
  tally() %>% 
  arrange(year)
  
```

# Tally by farm

```{r}
cleaned %>% 
  mutate(farm_id = if_else(farm_id %in% c("BAT", "SAV"), "UA", farm_id)) %>% 
  group_by(farm_id) %>% 
  tally(sort = TRUE)
```

# Tally by breed code

```{r}
cleaned %>% 
  distinct(farm_id, temp_id, breed_code) %>% 
  group_by(breed_code) %>% 
  tally(sort = TRUE)
  
```

# Number of scores per animal

```{r}
cleaned %>% 
  group_by(farm_id, temp_id) %>% 
  tally(sort = TRUE) %>%
  ungroup() %>% 
  group_by(n) %>% 
  summarise(n_animals = n()) %>% 
  ungroup() %>% 
  mutate(percent = scales::percent(n_animals/sum(n_animals)),
         n_animals = scales::comma(n_animals)) %>% 
  rename(n_records = n) 
```

## How many animals have multiple years of data?

```{r}
cleaned %>% 
  group_by(farm_id, temp_id) %>% 
  summarise(n = n_distinct(year)) %>%
  ungroup() %>% 
  group_by(n) %>% 
  summarise(n_animals = n()) %>% 
  ungroup() %>% 
  mutate(percent = scales::percent(n_animals/sum(n_animals)),
         n_animals = scales::comma(n_animals)) %>% 
  rename(n_years = n) 
```

## How many animals have multiple records per year?

```{r}
cleaned %>% 
  group_by(farm_id, temp_id, year) %>% 
  tally(sort = TRUE)
```

# Hair score summary 

```{r}
cleaned %>% 
  summarise(mean = mean(hair_score),
            sd = sd(hair_score),
            median = median(hair_score))
```

```{r}
cleaned %>% 
  ggplot(aes(x = hair_score)) +
  geom_histogram(bins = 5)
```

# Hair score breeding value summary

```{r, eval = FALSE}

bvs %>% 
  summarise(median = mean(solution),
            min = min(solution),
            max = max(solution))

```


# Sample map

```{r, eval = FALSE}
usa <- 
  borders("state", regions = ".", fill = "white", colour = "black")
```

```{r, warning=FALSE, message=FALSE, eval=FALSE}
coord_key <- read_csv(here::here("data/derived_data/environmental_data/coord_key.csv"))
```

```{r, warning=FALSE, message=FALSE, eval = FALSE}
fescue_belt <- 
  readxl::read_excel(here::here("data/raw_data/fescue_coordinates.xlsx")) %>% 
  rename(long = lng)
```

```{r, eval = FALSE}
map_dat <-
  breed_key %>% 
  select(-breed_code) %>% 
  left_join(cleaned) %>% 
  mutate(map_breed = case_when(cross == "AN" ~ "Angus",
                               an >= 0.625 ~ "Angus",
                               cross == "HFD" ~ "Hereford",
                               hfd >= 0.625 ~ "Hereford",
                               cross == "BGR" ~ "Brangus",
                               cross == "RAN" ~ "Red Angus",
                               cross == "CHA" ~ "Charolais",
                               cross == "SH" ~ "Shorthorn",
                               cross == "RDP" ~ "Maine-Anjou",
                               cross == "GEL" ~ "Gelbvieh",
                               gv >= 0.625 ~ "Gelbvieh", 
                               str_detect(full_reg, "^GVH") ~ "Gelbvieh",
                               source == "American Gelbvieh Association" ~ "Gelbvieh",
                               cross == "RAN" ~ "Red Angus",
                               ar >= 0.625 ~ "Red Angus",
                               str_detect(full_reg, "^RAN") ~ "Red Angus",
                               source == "Red Angus Association of America" ~ "Red Angus",
                               cross == "SIM" ~ "Simmental",
                               sim >= 0.625 ~ "Simmental",
                               TRUE ~ "Crossbred or other"),
         map_color = case_when(map_breed == "Crossbred or other" ~ "#a2ceaa",
                               map_breed == "Angus" ~ "#4f6980",
                               map_breed == "Hereford" ~ "#f47942",
                               map_breed == "Red Angus" ~ "#fbb04e",
                               map_breed == "Simmental" ~ "#638b66",
                               map_breed == "Brangus" ~ "#bfbb60",
                               map_breed == "Gelbvieh"~ "#d7ce9f",
                               map_breed == "Charolais"~ "#849db1",
                               map_breed == "Shorthorn"~ "#b9aa97",
                               map_breed == "Maine-Anjou"~ "#7e756d"),
         map_breed = case_when(map_breed == "Crossbred or other" ~ "Crossbred or other: 14,986",
                               map_breed == "Angus" ~ "Angus: 10,222",
                               map_breed == "Hereford" ~ "Hereford: 2,993",
                               map_breed == "Red Angus" ~ "Red Angus: 2,316",
                               map_breed == "Simmental" ~ "Simmental: 2,288",
                               map_breed == "Brangus" ~ "Brangus: 1,918",
                               map_breed == "Gelbvieh" ~ "Gelbvieh: 748",
                               map_breed == "Charolais" ~ "Charolais: 676",
                               map_breed == "Shorthorn" ~ "Shorthorn: 489",
                               map_breed == "Maine-Anjou" ~ "Maine-Anjou: 263",
                               TRUE ~ map_breed),
         map_breed = forcats::fct_infreq(map_breed)) %>% 
  left_join(coord_key %>% 
              select(farm_id, lat, long)) %>% 
  group_by(map_breed, lat, long, map_color) %>%
  summarise(n = n()) %>% 
  ungroup()
  

```

https://jrnold.github.io/ggthemes/reference/tableau_color_pal.html

* Angus: Blues ("#4f6980", "#849db1")
* IGS/Simmental: Dark greens ("#638b66", "#a2ceaa")
* Hereford: Orange/yellow ("#f47942", "#fbb04e")
* Brangus: Light greens

```{r, fig.width=5, fig.height=4, eval = FALSE}
ggplot(fescue_belt,
       aes(x = long, y = lat)) +
  usa +
  # Fescue belt shape
  ggforce::geom_shape(expand = unit(0.1, 'mm'),
                      radius = unit(0.4, 'mm'),
                      alpha = 0.3) +
  geom_point(data = map_dat,
             aes(x = long,
                 y = lat,
                 color = map_breed,
                 size = n),
             alpha = 0.85,
             position = position_jitter(width = 0.4,
                                        height = 0.2)) +
  scale_color_manual(values = c("Crossbred or other: 14,986" = "#a2ceaa",
                                "Angus: 10,222" = "#4f6980",
                                "Hereford: 2,993" = "#f47942",
                                "Red Angus: 2,316" = "#fbb04e",
                                "Simmental: 2,288" = "#638b66",
                                "Brangus: 1,918" = "#bfbb60",
                                "Gelbvieh: 748" = "#d7ce9f",
                                "Charolais: 676" = "#849db1",
                                "Shorthorn: 489" = "#b9aa97",
                                "Maine-Anjou: 263" = "#7e756d")) +
  guides(color = guide_legend(title = NULL),
         # Turn off size guide
         size = FALSE) + 
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_map("albers",
            lat0 = 39,
            lat1 = 45) +
  cowplot::theme_map() +
  guides(color = guide_legend(override.aes = list(size = 1.5,
                                                  alpha = 1),
                              nrow = 4)) +
  labs(x = NULL,
       y = NULL,
       title = NULL) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.box = "vertical",
        legend.spacing.y = unit(.1, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size = 10),
        # top, right, bottom, left
        legend.box.margin = margin(b = 0.1,
                                   l = 0.1,
                                   r = 0.1,
                                   unit = "in"),
        plot.margin = margin(t = 0.175,
                             r = 0,
                             b = 0,
                             l = 0,
                             unit = "mm"))
```


```{r, fig.width=5, fig.height=4}
ggsave(here::here("figures/data_summary/breed_map.png"),
       width = 7,
       height = 4)

```



# Commentary

Data was collected over 9 years by 77 beef cattle producers and university groups.

When an animal's date of birth was available, its "age class" was calculated based on the date the score was recorded, where reported score dates were assumed to be May 1 of the scoring year for the purposes of age class calculation. Age class was calculated as (n*365d)-90d to ((n+1)*365d)-90d, where n is the age classification and d is days. This means that animals that hadn't yet reached their first birthday could still be classified as yearlings and so on. Age class calculations were based on the BIF age-of-dam definitions and hair shedding scores recorded on animals fewer than 275 (i.e., 365-90) days of age were excluded. Animals with differing sexes reported across multiple years were also excluded. After filtering, 36,899 phenotypes from 13,364 cattle were retained for analysis. Most cattle were hair shedding scored once per year between mid-April and mid-June, but some groups chose to score multiple times across the span of several months. This resulted in between 1 and 8 scores per animal per year. Most cattle were scored in at least two separate years (8,839 or 66.11% of all individuals).


