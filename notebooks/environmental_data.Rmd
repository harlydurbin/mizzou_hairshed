---
title: "Environmental variables"
author: "Harly Durbin"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyr)
library(stringr)
library(dplyr)
library(glue)
library(readxl)
library(ggplot2)
library(magrittr)
library(purrr)
library(tidylog)

```

# Notes & questions

# Setup

```{r, warning=FALSE, message=FALSE}
cleaned <- read_rds(here::here("data/derived_data/import_join_clean/cleaned.rds"))
```

```{r, message=FALSE, warning=FALSE}
weather <- 
  read_rds(here::here("data/derived_data/environmental_data/weather.rds")) %>%  
  # Pull daily data from the `data` column and save it to its own column 
  mutate(daily = purrr::map(data, "daily", .default = NA),
         # Extract daily high from daily column
         daily_high = purrr::map_dbl(daily,
                              ~ .x %>% 
                                dplyr::pull(temperatureHigh)),
         apparent_high = purrr::map_dbl(daily,
                              ~ .x %>% 
                                dplyr::pull(apparentTemperatureHigh))) %>% 
  # Remove the data column
  select(-data) 


```

```{r, message=FALSE, warning=FALSE}
coord_key <- read_csv(here::here("data/derived_data/environmental_data/coord_key.csv"))
```

# Data summary

## Days from May 1

```{r}
cleaned %>% 
  filter(!is.na(date_score_recorded)) %>% 
  mutate(from_may1 = as.numeric(date_score_recorded - lubridate::ymd(glue("{year}/05/01")))) %>% 
  summarise(mean = mean(from_may1),
            median = median(from_may1))
```

```{r}
cleaned %>% 
  filter(!is.na(date_score_recorded)) %>% 
  mutate(from_may1 = as.numeric(date_score_recorded - lubridate::ymd(glue("{year}/05/01")))) %>% 
  ggplot(aes(x = from_may1)) +
  geom_density()
```

## Daily high temperature

```{r}
weather %>% 
  group_by(date_score_recorded, lat, long) %>% 
  summarise(mean_high = mean(daily_high)) %>% 
  ungroup() %>% 
  ggplot(aes(x = mean_high)) +
  geom_density()
```

# Correlation

```{r}
weather %>% 
  group_by(date_score_recorded, lat, long) %>% 
  # Take rows for max 30 days
  slice_max(order_by = value, n = 30) %>% 
  summarise(mean_real_high = mean(daily_high),
            mean_apparent_high = mean(apparent_high)) %>% 
  ungroup() %>% 
  right_join(cleaned %>% 
               filter(!is.na(date_score_recorded)) %>% 
               left_join(coord_key %>% 
                           select(farm_id, lat, long))) %>% 
  mutate(from_may1 = as.numeric(date_score_recorded - lubridate::ymd(glue("{year}/05/01")))) %>% 
  select(from_may1, lat, mean_apparent_high) %>% 
  corrr::correlate()

```

