---
title: "Gatherig environmental and location data"
author: "Harly Durbin"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyr)
library(stringr)
library(dplyr)
library(glue)
library(readxl)
library(magrittr)
library(tidygeocoder)
library(tidylog)

source(here::here("source_functions/coalesce_join.R"))
```

# Notes & questions

# Setup

```{r, warning=FALSE, message=FALSE}
cleaned <- read_rds(here::here("data/derived_data/import_join_clean/cleaned.rds"))
```

# Latitude coordinate key

```{r}
coord_key <-
  cleaned %>% 
  distinct(farm_id) %>% 
  left_join(read_excel(here::here("data/raw_data/farm_numbers.xlsx")) %>% 
              janitor::clean_names() %>% 
              select(farm_id, street = address, city, state, zip)) %>% 
  mutate(query = case_when(!is.na(street) ~
           glue("{street}, {city}, {state}, {zip}"),
         TRUE ~ 
           glue("{city}, {state}, {zip}"))) %>%
  geocode(address = query,
          method = 'cascade',
          return_addresses = TRUE) %>% 
  select(-query) %>% 
  mutate(address = if_else(is.na(lat), NA_character_, address),
         geo_method = if_else(is.na(lat), NA_character_, geo_method))
```

```{r}
coord_key %<>% 
  filter(is.na(lat)) %>% 
  arrange(farm_id) %>% 
  select(-lat, -long, -geo_method, -address) %>% 
  mutate(query = glue("{city}, {state}, {zip}")) %>% 
  geocode(address = query,
          method = 'cascade', 
          return_addresses = TRUE) %>% 
  select(-query) %>% 
  coalesce_join(coord_key,
                join = dplyr::right_join,
                by = c("farm_id", "street", "city", "state", "zip"))
  
```

```{r}
coord_key %>% 
  write_csv(here::here("data/derived_data/environmental_data/coord_key.csv"),
            na = "")
```

# Weather data

## List of dates to pull data for

```{r}
cleaned %>% 
  filter(!is.na(date_score_recorded)) %>% 
  left_join(read_csv(here::here("data/derived_data/environmental_data/coord_key.csv")) %>% 
              select(farm_id, lat, long)) %>% 
  distinct(date_score_recorded, lat, long)
```



```{r, eval = FALSE}

weather <-  
  joined_files %>% 
  #Append zipcodes by matching location key
  left_join(location_key %>% 
              select(location, zip), 
            by = c("location")) %>% 
  rename(zipcode = zip) %>%
  #append coordinates by zipcode
  left_join(read_csv(here::here("data/raw_data/zips_to_coordinates.csv")) %>% 
              janitor::clean_names() %>% 
              rename("zipcode" = "zip"),
            by = c("zipcode")) %>% 
  filter(!is.na(zipcode) & !is.na(date_score_recorded)) %>%
  distinct(zipcode, lat, lng, date_score_recorded) %>%
  mutate(sixty_prior = map(date_score_recorded,
                           ~ seq(.x - 59, .x, by = "days")),
         sixty_prior = map(sixty_prior, as_tibble)) %>% 
  unnest() %>% 
  select(zipcode, lat, lng, value) %>% 
  distinct()
```


# Dark Sky API

```{r}

weather_done <- 
  read_rds(here::here("data/derived_data/weather_done.rds")) %>% 
  # Pull hourly data from the `data` column and save it to its own column 
  mutate(hourly = map(data, "hourly", .default = NA),
         # Pull daily average data from the `data` column and save 
         # it to its own column 
         daily = map(data, "daily", .default = NA)) %>% 
  # Remove the data column
  select(-data) %>% 
  rename(date_score_recorded = value) 

weather_done %>% 
  unnest(daily)




```



