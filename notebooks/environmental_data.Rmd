---
title: "Environmental variables"
author: "Harly Durbin"
output:
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(readr)
library(tidyr)
library(stringr)
library(dplyr)
library(glue)
library(readxl)
library(ggplot2)
library(magrittr)
library(purrr)
library(tidylog)

source(here::here("source_functions/melt_aireml.R"))
source(here::here("source_functions/parse_renf90table.R"))
```

# Notes & questions

# Setup

```{r, warning=FALSE, message=FALSE}
cleaned <- read_rds(here::here("data/derived_data/import_join_clean/cleaned.rds"))
```

```{r, message=FALSE, warning=FALSE}
weather <- 
  read_rds(here::here("data/derived_data/environmental_data/weather.rds")) %>%  
  # Pull daily data from the `data` column and save it to its own column 
  mutate(daily = purrr::map(data, "daily", .default = NA),
         # Extract daily high from daily column
         daily_high = purrr::map_dbl(daily,
                              ~ .x %>% 
                                dplyr::pull(temperatureHigh)),
         apparent_high = purrr::map_dbl(daily,
                              ~ .x %>% 
                                dplyr::pull(apparentTemperatureHigh)),
         sunrise = purrr::map_chr(daily,
                                  ~.x %>% 
                                    dplyr::pull(sunriseTime) %>% 
                                    as.character(.)),
         sunset = purrr::map_chr(daily,
                                  ~.x %>% 
                                    dplyr::pull(sunsetTime) %>% 
                                    as.character(.)),
         sunrise = lubridate::as_datetime(sunrise),
         sunset = lubridate::as_datetime(sunset),
         day_length = as.numeric(sunset - sunrise)) %>% 
  # Remove the data column
  select(-data) 


```

```{r, message=FALSE, warning=FALSE}
coord_key <- read_csv(here::here("data/derived_data/environmental_data/coord_key.csv"))
```

# Data summary

## Days from May 1

```{r, message=FALSE, warning=FALSE}
cleaned %>% 
  filter(!is.na(date_score_recorded)) %>% 
  mutate(from_may1 = as.numeric(date_score_recorded - lubridate::ymd(glue("{year}/05/01")))) %>% 
  summarise(`Mean date deviation` = mean(from_may1),
            `Median date deviation` = median(from_may1),
            `SD date deviation` = sd(from_may1))
```

```{r, message=FALSE, warning=FALSE}
cleaned %>% 
  filter(!is.na(date_score_recorded)) %>% 
  mutate(from_may1 = as.numeric(date_score_recorded - lubridate::ymd(glue("{year}/05/01")))) %>% 
  ggplot(aes(x = from_may1)) +
  geom_histogram(bins = 15) +
  theme_classic() +
  labs(x = "Days from May 1 when score was recorded",
       y = "Kernel density")
```

## Mean apparent high temperature

```{r, message=FALSE, warning=FALSE}
weather %>% 
  group_by(date_score_recorded, lat, long) %>% 
  slice_max(order_by = value, n = 30) %>% 
  summarise(mean_apparent_high = mean(apparent_high)) %>% 
  ungroup() %>% 
  summarise(`Mean of mean apparent high` = mean(mean_apparent_high),
            `Median mean apparent high` = median(mean_apparent_high),
            `SD mean apparent high` = sd(mean_apparent_high))
```

```{r, message=FALSE, warning=FALSE}
weather %>% 
  group_by(date_score_recorded, lat, long) %>% 
  slice_max(order_by = value, n = 30) %>% 
  summarise(mean_apparent_high = mean(apparent_high)) %>% 
  ungroup() %>% 
  ggplot(aes(x = mean_apparent_high)) +
  geom_density() +
  theme_classic() +
  labs(x = "Mean of high apparent temperature in 30 days prior to scoring",
       y = "Kernel density")
```

## Day length

```{r}
weather %>% 
  group_by(date_score_recorded, lat, long) %>% 
  slice_max(order_by = value, n = 30) %>% 
  summarise(mean_day_length = mean(day_length)) %>% 
  ungroup() %>% 
  summarise(`Min. mean day length` = min(mean_day_length),
            `Max. mean day length` = max(mean_day_length),
            `Mean of mean day length` = mean(mean_day_length),
            `Median mean day length` = median(mean_day_length),
            `SD mean day length` = sd(mean_day_length))
```

```{r, message=FALSE, warning=FALSE}
weather %>% 
  group_by(date_score_recorded, lat, long) %>% 
  slice_max(order_by = value, n = 30) %>% 
  summarise(mean_day_length = mean(day_length)) %>% 
  ungroup() %>% 
  ggplot(aes(x = mean_day_length)) +
  geom_density() +
  theme_classic() +
  labs(x = "Mean of day length in 30 days prior to scoring",
       y = "Kernel density")
```

## Correlations

```{r}
weather %>% 
  group_by(date_score_recorded, lat, long) %>% 
  # Take rows for max 30 days
  slice_max(order_by = value, n = 30) %>% 
  summarise(mean_apparent_high = mean(apparent_high),
            mean_day_length = mean(day_length)) %>% 
  ungroup() %>% 
  right_join(cleaned %>% 
               filter(!is.na(date_score_recorded)) %>% 
               left_join(coord_key %>% 
                           select(farm_id, lat, long))) %>% 
  mutate(from_may1 = as.numeric(date_score_recorded - lubridate::ymd(glue("{year}/05/01")))) %>% 
  select(from_may1, lat, mean_apparent_high, mean_day_length) %>% 
  corrr::correlate()

```

# `fixed2` and `fixed3` model BLUEs

```{r, warning=FALSE, message=FALSE}
read_table2(here::here("data/derived_data/base_varcomp/fixed2/solutions"),
            skip = 1,
            col_names = c("trait", "effect", "id_renamed", "solution", "se")) %>%
  filter(effect %in% c(5, 6)) %>% 
  mutate(effect = case_when(effect == 5 ~ "Mean apparent high temperature",
                            effect == 6 ~ "Latitude")) %>% 
  select(Effect = effect, Solution = solution, SE = se)
```

```{r, warning=FALSE, message=FALSE}
read_table2(here::here("data/derived_data/base_varcomp/fixed3/solutions"),
            skip = 1,
            col_names = c("trait", "effect", "id_renamed", "solution", "se")) %>%
  filter(effect %in% c(5, 6)) %>% 
  mutate(effect = case_when(effect == 5 ~ "Mean apparent high temperature",
                            effect == 6 ~ "Mean day length")) %>% 
  select(Effect = effect, Solution = solution, SE = se)
```

```{r}
pracma::legendre(n = 2, x = 13)
```


# Commentary

The mean apparent high temperature was found to be highly correlated with the date a score was recorded (Pearson r = 0.82) but only moderately correlated with latitude (Pearson r = -0.21). For this reason, we chose to use latitude as the only proxy for day length and exclude score date from analyses dissecting the effects of temperature vs. photoperiod.