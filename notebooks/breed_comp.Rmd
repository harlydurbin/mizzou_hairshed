---
title: "Breed composition"
author: "Harly Durbin"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyr)
library(stringr)
library(dplyr)
library(glue)
library(readxl)
library(magrittr)
library(tidylog)


```

# Notes & questions

* ~~Send Jordan Bowman ped from April and ask for breed comp~~
* Pull together ANR ped from April, add new animals, ask Ryan Bolt for breed comp
* Run for breeds with > 1,500 records? AN, SIM, HFD, ANR, BG, CHA

# Setup

```{r, warning=FALSE, message=FALSE}
cleaned <- read_rds(here::here("data/derived_data/import_join_clean/cleaned.rds"))
```

```{r}
full_ped <- read_rds(here::here("data/derived_data/3gen/full_ped.rds"))
```

# Data summary

```{r}
cleaned %>% 
  filter(!farm_id %in% c("SAV", "BAT")) %>% 
  group_by(breed_code) %>% 
  tally(sort = TRUE)
```

```{r}
cleaned %>% 
  group_by(breed_code) %>% 
  tally(sort = TRUE)
```

# Assign breed codes

```{r}
breed_test <-
  cleaned %>% 
  distinct(farm_id, temp_id, animal_id, registration_number, breed_code, Lab_ID) %>% 
  filter(!farm_id %in% c("SAV", "BAT")) %>%
  coalesce_join(rhf_breed, 
                by = c("farm_id", "animal_id", "Lab_ID", "temp_id"),
                join = dplyr::left_join)
```

```{r}
breed_test %<>%
  coalesce_join(read_excel(here::here("data/raw_data/201005.misc_breed.xlsx")),
                by = c("farm_id", "registration_number", "animal_id"),
                join = dplyr::left_join)
```

```{r}
breed_test %<>%
  left_join(full_ped %>%
              distinct(farm_id, temp_id, full_reg)) %>%
  mutate(breed_code = case_when(breed_code == "AN" ~ "AAA",
                                breed_code == "ANR" ~ "RAN",
                                breed_code == "BG" ~ "BGR",
                                breed_code == "BRN" ~ "BSW",
                                breed_code == "MAAN" ~ "RDP",
                                TRUE ~ breed_code),
         full_reg = case_when(is.na(full_reg) &
                                !is.na(registration_number) ~ glue("{breed_code}{registration_number}"),
                              is.na(full_reg) &
                                is.na(registration_number) ~ glue("{farm_id}{animal_id}{temp_id}"),
                              TRUE ~ full_reg))
```

```{r}
breed_test %<>%
  mutate(cross = case_when(!is.na(cross) ~ cross,
                           breed_code %in% c("SH", "RDP", "HFD", "BSW", "SIMB", "BGR", "CHA", "GEL", "CROS", "CHIA") ~
                             breed_code,
                           str_detect(full_reg, "AAA|BIR") ~
                             "AN",
                           farm_id %in% c("UMCT", "WAA", "HAF", "KAF", "DRR", "RAAF") ~
                             "AN",
                           farm_id %in% c("SRA") ~
                             "RAN",
                           str_detect(registration_number, "^6") ~ 
                             "AN")) %>% 
  id_search(source_col = full_reg,
            search_df = sim_breed %>% 
              mutate(dummy_reg = glue("SIM{registration_number}")),
            search_col = dummy_reg,
            key_col = cross) %>% 
  id_search(source_col = full_reg,
            search_df = ran_breed %>% 
              mutate(dummy_reg = glue("RAN{registration_number}")),
            search_col = dummy_reg,
            key_col = cross) %>% 
  id_search(source_col = registration_number,
            search_df = sim_breed,
            search_col = registration_number,
            key_col = cross) %>% 
  id_search(source_col = registration_number,
            search_df = ran_breed %>% 
              mutate(registration_number = as.character(registration_number)),
            search_col = registration_number,
            key_col = cross)
```

```{r}
breed_test %>% 
  mutate(cross = case_when(cross %in% c("CROS", "CS", "cross", "MX") ~ "cross",
                           is.na(cross) ~ "cross",
                           cross %in% c("SIM", "SM") ~ "SIM",
                           cross %in% c("RAN", "AR") ~ "RAN",
                           TRUE ~ cross)) %>% 
  group_by(cross) %>% 
  tally(sort = TRUE)
```


