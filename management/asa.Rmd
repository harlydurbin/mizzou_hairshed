---
title: "Simmental cleanup transfers"
author: "Harly Durbin"
date: "10/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(readxl)
library(tidyr)
library(purrr)
library(dplyr)
library(tidylog)

source(here::here("source_functions/animal_table.R"))
source(here::here("source_functions/tissue_table.R"))
```

# Setup

```{r}
animal_table <- get_animal_table("190907")

write_rds(animal_table, here::here("data/derived_data/animal_table.rds"))
```

```{r, echo=TRUE, eval = FALSE}
tissue <- get_tissue("190907")

write_rds(tissue, here::here("data/derived_data/tissue.rds"))
```

```{r sent, message=FALSE, warning=FALSE, results='hide'}
source(here::here("source_functions/sent_samples.R"))
```

```{r}
sent2 <-
  sent %>%
  left_join(animal_table %>%
              select(Lab_ID,
                     Reg,
                     Ref_ID,
                     Ref_ID2,
                     breed_assoc_reg))
```


# Reformat file Jared created

```{r}

read_csv("~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190830.SIM.csv") %>% 
  janitor::clean_names() %>% 
  rename(Reg = a_s_a_registration_number) %>% 
  mutate(
    Reg = as.character(Reg),
    Reg = if_else(is.na(Reg), barcode, Reg)
    ) %>% 
  left_join(animal_table) %>% 
  select(
    Lab_ID,
    Reg,
    Barcode = Ref_ID2,
    Ref_ID, 
    Ref_ID_source,
    BC,
    Sex,
    DOB,
    Sire_Reg,
    Dam_Reg,
    registered,
    breed_assoc
    ) %>% 
  mutate(
    source_code = "GIB",
    assoc_code = "SIM"
  ) %>% 
  filter(!is.na(Ref_ID)) %>%
  writexl::write_xlsx("~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20191029.SIM.xlsx")
  
  

```

```{r}
sim_transfers <-
  c(
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20191029.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20191004.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190708.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190708.SIM_retest.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190625.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20181106.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20181218.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190108.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190312.SIM.xlsx"
  ) %>%
  set_names(
    c(
      "20191029",
      "20191004",
      "20190708",
      "20190708_retest",
      "20190625",
      "20181106",
      "20181218",
      "20190108",
      "20190312"
    )
  ) %>%
  purrr::map_dfr( ~ read_excel(.x, col_types = "text"), .id = "transfer_date") %>%
  bind_rows(
    c(
      "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/180306_sim_transfer.csv",
      "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/180823.SIM.csv",
      "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/sim_20180329.csv"
    ) %>%
      set_names(c("20180306",
                  "20180823",
                  "20180329")) %>%
      purrr::map_dfr( ~ read_csv(.x, col_types = cols(.default = "c")), .id = "transfer_date") %>%
      mutate(
        Farm_ID = if_else(!is.na(Farm_name), Farm_name, Farm_ID),
        Barcode = if_else(
          !is.na(`180306_sim_transfer_Barcode`),
          `180306_sim_transfer_Barcode`,
          Barcode
        ),
        Ref_ID = if_else(!is.na(Animal_ID), Animal_ID, Ref_ID)
      ) %>%
      select(
        transfer_date,
        source_code = Farm_ID,
        Reg,
        BC,
        Barcode,
        breed_assoc,
        Lab_ID,
        Ref_ID,
        Ref_ID_source,
        Sex
      ) %>% 
      mutate(transfer_date = lubridate::ymd(transfer_date)) %>% 
      group_by(Reg) %>% 
      filter(transfer_date == max(transfer_date)) %>% 
      ungroup() %>% 
      mutate(transfer_date = as.character(transfer_date))
      
  )
```

```{r}
sim_transfers %>% 
  group_by(Reg) %>% 
  filter(n() > 1) %>% 
  arrange(Reg)
```


```{r}
read_excel(here::here("data/raw_data/Gibbs Farms - Cow Herd - No GE Reported (as of 10-24-19).xls"), skip = 2) %>% 
  left_join(sim_transfers %>% 
              select(transfer_date, Reg),
            by = c("ASA" = "Reg")) %>% 
  mutate(
    transfer_date = 
      case_when(
        transfer_date == "20191029" ~ lubridate::ymd("20190830"),
        TRUE ~ lubridate::ymd(transfer_date))
    ) %>% 
  writexl::write_xlsx("~/Desktop/20191029.gibbs_no_ge.xlsx")
```

```{r}
read_excel(
  here::here(
    "data/raw_data/Gibbs Farms - Cow Herd - No GE Reported (as of 10-24-19).xls"
  ),
  skip = 2
) %>%
  left_join(sim_transfers %>%
              select(transfer_date, Reg),
            by = c("ASA" = "Reg")) %>%
  mutate(transfer_date =
           case_when(
             transfer_date == "20191029" ~ lubridate::ymd("20190830"),
             TRUE ~ lubridate::ymd(transfer_date)
           )) %>%
  filter(is.na(transfer_date)) %>%
  left_join(sent2,
            by = c("ASA" = "Reg"))
```

```{r}
read_excel(
  here::here(
    "data/raw_data/Gibbs Farms - Cow Herd - No GE Reported (as of 10-24-19).xls"
  ),
  skip = 2
) %>%
  left_join(sim_transfers %>%
              select(transfer_date, Reg),
            by = c("ASA" = "Reg")) %>%
  mutate(transfer_date =
           case_when(
             transfer_date == "20191029" ~ lubridate::ymd("20190830"),
             TRUE ~ lubridate::ymd(transfer_date)
           )) %>%
  filter(is.na(transfer_date)) %>% 
  filter(Tattoo %in% sent2$Ref_ID)
  
```

