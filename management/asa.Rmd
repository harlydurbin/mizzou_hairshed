---
title: "Simmental cleanup transfers"
author: "Harly Durbin"
date: "10/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(readxl)
library(tidyr)
library(purrr)
library(dplyr)
library(tidylog)

source(here::here("source_functions/animal_table.R"))
source(here::here("source_functions/tissue_table.R"))
```

# Setup

```{r}
animal_table <- get_animal_table("190907")

write_rds(animal_table, here::here("data/derived_data/animal_table.rds"))
```

```{r, echo=TRUE, eval = FALSE}
tissue <- get_tissue("190907")

write_rds(tissue, here::here("data/derived_data/tissue.rds"))
```

```{r sent, message=FALSE, warning=FALSE, results='hide'}
source(here::here("source_functions/sent_samples.R"))
```

```{r}
sent2 <-
  sent %>%
  left_join(animal_table %>%
              select(Lab_ID,
                     Reg,
                     Ref_ID,
                     Ref_ID2,
                     breed_assoc_reg))
```


# Reformat file Jared created

```{r}

read_csv("~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190830.SIM.csv") %>% 
  janitor::clean_names() %>% 
  rename(Reg = a_s_a_registration_number) %>% 
  mutate(
    Reg = as.character(Reg),
    Reg = if_else(is.na(Reg), barcode, Reg)
    ) %>% 
  left_join(animal_table) %>% 
  select(
    Lab_ID,
    Reg,
    Barcode = Ref_ID2,
    Ref_ID, 
    Ref_ID_source,
    BC,
    Sex,
    DOB,
    Sire_Reg,
    Dam_Reg,
    registered,
    breed_assoc
    ) %>% 
  mutate(
    source_code = "GIB",
    assoc_code = "SIM"
  ) %>% 
  filter(!is.na(Ref_ID)) %>%
  writexl::write_xlsx("~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20191029.SIM.xlsx")
  
  

```

```{r}
sim_transfers <-
  c(
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20191029.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20191004.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190708.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190708.SIM_retest.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190625.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20181106.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20181218.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190108.SIM.xlsx",
    "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/20190312.SIM.xlsx"
  ) %>%
  set_names(
    c(
      "20191029",
      "20191004",
      "20190708",
      "20190708_retest",
      "20190625",
      "20181106",
      "20181218",
      "20190108",
      "20190312"
    )
  ) %>%
  purrr::map_dfr( ~ read_excel(.x, col_types = "text"), .id = "transfer_date") %>%
  bind_rows(
    c(
      "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/180306_sim_transfer.csv",
      "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/180823.SIM.csv",
      "~/Box Sync/HairShedding/ReportedData/SendToBreedAssociations/sim_20180329.csv"
    ) %>%
      set_names(c("20180306",
                  "20180823",
                  "20180329")) %>%
      purrr::map_dfr( ~ read_csv(.x, col_types = cols(.default = "c")), .id = "transfer_date") %>%
      mutate(
        Farm_ID = if_else(!is.na(Farm_name), Farm_name, Farm_ID),
        Barcode = if_else(
          !is.na(`180306_sim_transfer_Barcode`),
          `180306_sim_transfer_Barcode`,
          Barcode
        ),
        Ref_ID = if_else(!is.na(Animal_ID), Animal_ID, Ref_ID)
      ) %>%
      select(
        transfer_date,
        source_code = Farm_ID,
        Reg,
        BC,
        Barcode,
        breed_assoc,
        Lab_ID,
        Ref_ID,
        Ref_ID_source,
        Sex
      ) %>% 
      mutate(transfer_date = lubridate::ymd(transfer_date)) %>% 
      group_by(Reg) %>% 
      filter(transfer_date == max(transfer_date)) %>% 
      ungroup() %>% 
      mutate(transfer_date = as.character(transfer_date))
      
  )
```

```{r}
sim_transfers %>% 
  group_by(Reg) %>% 
  filter(n() > 1) %>% 
  arrange(Reg)
```


```{r}
read_excel(here::here("data/raw_data/Gibbs Farms - Cow Herd - No GE Reported (as of 10-24-19).xls"), skip = 2) %>% 
  left_join(sim_transfers %>% 
              select(transfer_date, Reg),
            by = c("ASA" = "Reg")) %>% 
  mutate(
    transfer_date = 
      case_when(
        transfer_date == "20191029" ~ lubridate::ymd("20190830"),
        TRUE ~ lubridate::ymd(transfer_date))
    ) %>% 
  writexl::write_xlsx("~/Desktop/20191029.gibbs_no_ge.xlsx")
```

```{r}
read_excel(
  here::here(
    "data/raw_data/Gibbs Farms - Cow Herd - No GE Reported (as of 10-24-19).xls"
  ),
  skip = 2
) %>%
  left_join(sim_transfers %>%
              select(transfer_date, Reg),
            by = c("ASA" = "Reg")) %>%
  mutate(transfer_date =
           case_when(
             transfer_date == "20191029" ~ lubridate::ymd("20190830"),
             TRUE ~ lubridate::ymd(transfer_date)
           )) %>%
  filter(is.na(transfer_date)) %>%
  left_join(sent2,
            by = c("ASA" = "Reg"))
```

```{r}
read_excel(
  here::here(
    "data/raw_data/Gibbs Farms - Cow Herd - No GE Reported (as of 10-24-19).xls"
  ),
  skip = 2
) %>%
  left_join(sim_transfers %>%
              select(transfer_date, Reg),
            by = c("ASA" = "Reg")) %>%
  mutate(transfer_date =
           case_when(
             transfer_date == "20191029" ~ lubridate::ymd("20190830"),
             TRUE ~ lubridate::ymd(transfer_date)
           )) %>%
  filter(is.na(transfer_date)) %>% 
  filter(Tattoo %in% sent2$Ref_ID)
  
```

```{r}
## ----setup, include=FALSE------------------------------------------------
library(readr)
library(tibble)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(reshape2)
library(magrittr)
library(ggsci)

## ------------------------------------------------------------------------

plot_dominica_fs <- function(dataset, in_dir, k, out_dir) {
  # dataset = "merged.rel025"
  # in_dir = "data/derived_data/fastStructure/191017"
  # k = 7
  # out_dir = "191017"
  
  
  # Set up population label key
  pop_key <-
    read_table2(
      here::here(glue::glue("data/plink/{dataset}.fam")),
      col_names = FALSE,
      col_types = cols(.default = "c")
    ) %>%
    select(id = X2) %>%
    left_join(read_table2(
      here::here("data/raw_data/sample_all_snp.txt"),
      col_names = c("id", "sex", "pop")
    )) %>%
    mutate(
      pop =
        case_when(
          !str_detect(id, "^HGDP") ~ "Dominica",
          TRUE ~ str_remove(pop, "_discover"),
        ),
      continent =
        case_when(
          pop %in% c(
            "San",
            "MbutiPygmy",
            "BiakaPygmy",
            "Mandenka",
            "BantuKenya",
            "BantuSouthAfrica",
            "Yoruba"
          ) ~ "Africa",
          pop %in% c("Mozabite", "Bedouin", "Palestinian", "Druze") ~ "Middle East",
          pop %in% c(
            "Adygei",
            "Sardinian",
            "Tuscan",
            "Italian",
            "French",
            "Orcadian",
            "Basque",
            "Russian"
          ) ~ "Europe",
          pop %in% c(
            "Makrani",
            "Balochi",
            "Brahui",
            "Kalash",
            "Burusho",
            "Pathan",
            "Sindhi",
            "Hazara",
            "Uygur"
          ) ~ "C.S. Asia",
          pop %in% c(
            "Yakut",
            "Mongola",
            "Tu",
            "Xibo",
            "Oroqen",
            "Hezhen",
            "Daur",
            "Japanese",
            "Yi",
            "Naxi",
            "Tujia",
            "Han-NChina",
            "Han",
            "She",
            "Miao",
            "Dai",
            "Lahu",
            "Cambodian"
          ) ~ "E. Asia",
          pop %in% c("Melanesian", "Papuan") ~ "Oceania",
          pop %in% c("Maya", "Pima", "Colombian", "Karitiana", "Surui", "Dominica") ~ "America"
        ),
      pop =
        case_when(
          pop == "MbutiPygmy" ~ "Mbuti Pygmy",
          pop == "BiakaPygmy" ~ "Biaka Pygmy",
          pop == "BantuSouthAfrica" ~ "Bantu (S. Africa)",
          pop == "BantuKenya" ~ "Bantu (Kenya)",
          pop == "Han-NChina" ~ "Han (N. China)",
          TRUE ~ pop
        )
    )
  
  
  # Read in results
  dat <-
    read_table2(here::here(glue::glue(
      "{in_dir}/{dataset}.fastStruct.{k}.meanQ"
    )), col_names = FALSE) %>%
    bind_cols(pop_key)
  
  
  # Establish column order to sort and arrange individuals on on
  col_order <-
    colnames(dat) %>%
    as_tibble() %>%
    filter(str_detect(value, "X")) %>%
    arrange(value) %>%
    dplyr::pull(value)
  
  
  dat %<>%
    arrange(!!!rlang::syms(col_order)) %>%
    mutate(id = forcats::fct_inorder(id)) %>%
    melt(id = c("id", "pop", "continent", "sex")) %>%
    arrange(continent, pop) %>%
    mutate(pop = forcats::fct_inorder(pop))
  
  ## ---- fig.height=12, fig.width=12----------------------------------------
  
  
  # Plotting dummy function
  plotting_dummy <- function(which) {
    g <-
      dat %>%
      filter(continent == which) %>%
      ggplot(aes(x = id,
                 y = value,
                 fill = variable)) +
      #Make a stacked bar plot that's scaled by ancestry percentage using the scales package
      geom_bar(position = "fill",
               stat = "identity",
               width = 1) +
      scale_y_continuous(labels = scales::percent) +
      scale_fill_ucscgb() +
      guides(fill = FALSE) +
      theme_minimal() +
      #Remove all x axis title info (i.e., international IDs)
      #facet_grid(~ pop, space = "free_x", scales = "free_x") +
      #coord_flip() +
      theme(
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.spacing.y = unit(0.2, "lines"),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        strip.text.x = element_text(angle = 90, size = 24),
        strip.text.y = element_text(size = 28, face = "bold")
      ) +
      facet_grid(
        cols = vars(pop),
        rows = vars(continent),
        scales = "free",
        space = "free",
        drop = TRUE,
        switch = "y",
        labeller = label_wrap_gen()
      )
    
    return(g)
  }
  
  ## ------------------------------------------------------------------------
  
  
  # Establish plot widths based on number of samples
  plot_widths <-
    dat %>%
    group_by(continent) %>%
    summarise(n_ids = n_distinct(id)) %>%
    right_join(
      tribble(
        ~ continent,
        ~ order,
        "Africa",
        1,
        "Middle East",
        2,
        "Europe",
        3,
        "C.S. Asia",
        4,
        "E. Asia",
        5,
        "Oceania",
        6,
        "America",
        7
      )
    ) %>%
    mutate(rel_width = n_ids / max(n_ids)) %>%
    arrange(order) %>%
    pull(rel_width)
  
  
  ## ------------------------------------------------------------------------
  ## make separate plots
  afr <- plotting_dummy(dat, "Africa")
  me <- plotting_dummy(dat, "Middle East")
  eur <- plotting_dummy(dat, "Europe")
  csa <- plotting_dummy(dat, "C.S. Asia")
  ea <- plotting_dummy(dat, "E. Asia")
  oc <- plotting_dummy(dat, "Oceania")
  am <- plotting_dummy(dat, "America")
  
  
  ## ---- fig.width=36, fig.height=12----------------------------------------
  
  all_plot <-
    cowplot::plot_grid(
      afr,
      me,
      eur,
      csa,
      ea,
      oc,
      am,
      rel_widths = plot_widths,
      rel_heights = rep(1, 7),
      align = "h",
      nrow = 1
    )
  
  cowplot::ggsave(
    plot = all_plot,
    filename = here::here(glue::glue(
      "{out_dir}/{dataset}.fastStructure.{k}.png"
    )),
    width = 36,
    height = 12
  )
  
}

```

