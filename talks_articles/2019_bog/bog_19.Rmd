---
title: "BoG 2019"
author: "Harly Durbin"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
#library(cowplot)
library(nlme)
library(forcats)
library(infer)
library(extrafont)
library(magrittr)


source(here::here("source_functions/cv_assign.R"))

# Had to use the old sample sheet bc international IDs in my genotype dump from 2/15 wouldn't match up otherwise
# (i.e., international IDs got fixed)
old_samp <- 
  read_delim(here::here("data/raw_data/190205_sample_sheet.csv"),
             delim = c(","),
             col_names = TRUE,
             guess_max = 10000) %>% 
  # This gets annoying so I'm renaming it
  rename(Lab_ID = lab_id,
         Reg = reg)

grm_metadata <- 
  read_table(here::here("data/raw_data/190215_hair_shedding.sample"),
             col_names = "international_id") %>% 
  mutate(international_id = str_remove(international_id, "1_")) %>% 
  left_join(old_samp %>% 
              select(international_id, Lab_ID) %>% 
              distinct(international_id, Lab_ID)) %>% 
  group_by(international_id) %>% 
  #NOF Gelbvieh duplicates strike again
  filter(Lab_ID == max(Lab_ID)) %>% 
  ungroup()

```

# Prepare `sommer` input

## GRM generated by GEMMA



```{r}
grm_raw <- read_rds(here::here("data/derived_data/grm_raw.rds"))
```


```{r}
grm_raw <- read_table2(here::here("data/raw_data/190215.9148.sXX.txt"), col_names = FALSE)

grm_raw <-
  grm_raw %>% 
  set_names(grm_metadata$international_id) %>% 
  bind_cols(grm_metadata %>% 
              dplyr::select(international_id)) %>% 
  tibble::column_to_rownames("international_id") %>%
  as.matrix()


```

## PCA covariates

```{r}
eigenval <-
  read_table2(here::here("data/derived_data/190417.eigenval"), col_names = "eigenval") %>% 
  mutate(pc = map_chr(1:20, ~ str_c("PC", .x)),
         pve = eigenval/sum(eigenval))

eigenvec <-
  read_table2(here::here("data/derived_data/190417.eigenvec"),
              col_names = FALSE) %>% 
  select(-X1) %>% 
  set_names(c("international_id", map_chr(1:20, ~ str_c("PC", .x)))) %>% 
  left_join(old_samp %>% 
              select(international_id, Lab_ID, sample_id),
            by = c("international_id")) %>% 
  left_join(nested_join %>%
              select(farm_id, animal_id, registration_number, breed_code, Lab_ID),
            by = c("Lab_ID"))
```

# Phenotypes

```{r}
pheno <- 
  long %>% 
  # Add date deviations
    dplyr::mutate(date_deviation = 
           case_when(
             year == "2019" & !is.na(date_score_recorded) ~ as.integer(date_score_recorded - mdy("5/1/2019")),
             year == "2018" & !is.na(date_score_recorded) ~ as.integer(date_score_recorded - mdy("5/1/2018")),
             year == "2017" & !is.na(date_score_recorded) ~ as.integer(date_score_recorded - mdy("5/1/2017")),   
             year == "2016" & !is.na(date_score_recorded) ~ as.integer(date_score_recorded - mdy("5/1/2016")),
             # mean impute
             # Need to figure out how to do this without hard coding
             year == "2016" & is.na(date_score_recorded) ~ as.integer(29),
             year == "2017" & is.na(date_score_recorded) ~ as.integer(31),
             year == "2018" & is.na(date_score_recorded) ~ as.integer(19)
                     )) %>% 
  dplyr::select(farm_id, animal_id, breed_code, Lab_ID, sex, age,
                calving_season, toxic_fescue, location, year,
                date_score_recorded, date_deviation, hair_score) %>% 
  # Add latitude by joining to location key
  left_join(read_csv(here::here("data/raw_data/location_key.csv")) %>% 
              janitor::clean_names() %>% 
              dplyr::select(location, lat) %>% 
              dplyr::mutate(location = stringr::str_to_upper(location))) %>% 
  # RHF doesn't need to be separated out into multiple contemp
  dplyr::mutate(
    location = case_when(
    farm_id == "RHF" ~ "RHF",
    TRUE ~ location
  )
  # # Fix wrong reg weird Brangus age
  # age = case_when(
  #   Lab_ID == 196414 ~ as.integer(4),
  #   TRUE ~ age
  # )
  ) %>%
  dplyr::mutate(
    # Squish together a contemporary group
    temp_group = stringr::str_c(location, year),
    # Remove space from temp group
    temp_group = stringr::str_remove(temp_group, "[[:blank:]]")) %>% 
  # Adding international ID by Lab ID
  left_join(old_samp %>% 
              dplyr::select(Lab_ID, international_id)) %>% 
  # Keep only if in the GRM
  dplyr::filter(Lab_ID %in% grm_metadata$Lab_ID) %>% 
  # Adding PCs by international_id
  left_join(eigenvec %>% 
              select(PC1, PC2, international_id)) %>% 
  mutate_at(vars("sex", "calving_season", "toxic_fescue", "temp_group", "international_id"),
            as_factor)


write_rds(pheno, here::here("data/derived_data/pheno.rds"))


visdat::vis_dat(pheno)

```


# Data summary

```{r}
long %>% 
  select(farm_id, breed_code,calving_season, toxic_fescue, year) %>% 
  inspectdf::inspect_cat(show_plot = T)
```


```{r}

pheno %>% 
  select(international_id, hair_score, year) %>% 
  mutate(international_id = as.character(international_id), 
         year = str_c("year_", year)) %>% 
  reshape2::dcast(international_id ~ year)

```


```{r}
long %>% 
  group_by(breed_code) %>% 
  tally()
```

```{r}
usa <- 
  borders("state", regions = ".", fill = "white", colour = "black")
```


```{r, fig.height=12, fig.width=18}


long %>%
  left_join(read_csv(here::here("data/raw_data/location_key.csv")) %>% 
              janitor::clean_names() %>% 
              dplyr::select(location, lat, lng) %>% 
              dplyr::mutate(location = stringr::str_to_upper(location))) %>% 
    #Take out NAs and Braunvieh sample
  filter(!is.na(breed_code) & !breed_code %in% c("BRN", "CHIA")) %>%
  #Verbose breed annotations
  mutate(breed_code = case_when(
    breed_code == "AN" ~ "Angus: 7,613",
    breed_code == "ANR" ~ "Red Angus: 1,526",
    breed_code == "BG" ~ "Brangus: 763",
    breed_code == "CHA" ~ "Charolais: 618",
    breed_code == "CROS" ~ "Crossbred: 942",
    breed_code == "GEL" ~ "Gelbvieh: 565",
    breed_code == "HFD" ~ "Hereford: 2,781", 
    breed_code == "MAAN" ~ "Maine-Anjou: 225",
    breed_code == "SH" ~ "Shorthorn: 356",
    breed_code == "SIM" ~ "Simmental: 5,510",
    breed_code == "SIMB" ~ "Simbrah: 56"
  )) %>% 
  #Reorder breed_code in order of frequency
  mutate(breed_code = forcats::fct_infreq(breed_code)) %>% 
  ggplot(aes(
    x = lng,
    y = lat,
    colour = breed_code
  )) +
  usa +
  geom_count(
    alpha = 0.7,
    position = position_jitter(width = 0.4,
                               height = 0.2)
    #Shift position of overlapping points so that they can be seen better
    # position = position_dodge(
    #   dodge.width = 0.7,
    #   padding = 0.2
    # )
  ) +
  scale_size_area(max_size = 15,
                  # No size guide
                  guide = 'none') +
  guides(col = guide_legend(title = "Breed")) +
  bakeoff::scale_color_bakeoff(reverse = TRUE, discrete = TRUE) +
  theme_classic() +
  theme(
    # No x or y axes anything
    axis.line = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    text = element_text(family = "Glacial Indifference"),
    legend.title = element_blank(),
    legend.text = element_text(size = 20),
    legend.background = element_rect(fill = "transparent",
                                    colour = NA),
    legend.justification = c(0, .05),
    legend.key.size = unit(1, "cm"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "transparent",
                                    colour = NA),
    plot.background = element_rect(fill = "transparent",
                                   colour = NA)
  ) +
  coord_map("albers", lat0 = 39, lat1 = 45) 

cowplot::ggsave(here::here("talks_articles/bog_19/breed_map_white.png"), dpi = 500)

```




# Read `sommer` output

```{r}

beta <-
  list.files(
    here::here("data/derived_data/sommer/reduce_full"),
    pattern = "190428.beta.",
    full.names = TRUE
  ) %>% 
  # Name the elements of the list based on a stripped down version of the filepath
  set_names(nm = (basename(.) %>%
                    tools::file_path_sans_ext())) %>%
  purrr::map_dfr(read_csv, .id = "mod") %>% 
  mutate(mod = str_remove_all(mod, "\\.190428\\.beta"))


blup <-
    list.files(
    here::here("data/derived_data/sommer/reduce_full"),
    pattern = "190428.blup.",
    full.names = TRUE
  ) %>% 
  # Name the elements of the list based on a stripped down version of the filepath
  set_names(nm = (basename(.) %>%
                    tools::file_path_sans_ext())) %>%
  purrr::map_dfr(read_csv, .id = "mod") %>% 
  mutate(mod = str_remove_all(mod, "\\.190428\\.blup"))

varcomp <-
    list.files(
    here::here("data/derived_data/sommer/reduce_full"),
    pattern = "190428.varcomp.",
    full.names = TRUE
  ) %>% 
  # Name the elements of the list based on a stripped down version of the filepath
  set_names(nm = (basename(.) %>%
                    tools::file_path_sans_ext())) %>%
  purrr::map_dfr(read_csv, .id = "mod") %>% 
  mutate(mod = str_remove_all(mod, "\\.190428\\.varcomp")) %>% 
  # Rename effects to genetic, permanent environment, temp environment
  mutate(
    effect = case_when(
      effect == "u:international_id.hair_score-hair_score" ~ "g",
      effect == "international_id.hair_score-hair_score" ~ "pe",
      effect == "units.hair_score-hair_score" ~ "te"
  ))


aic_bic <- 
    list.files(
    here::here("data/derived_data/sommer/reduce_full"),
    pattern = "190428.aic_bic.",
    full.names = TRUE
  ) %>% 
  # Name the elements of the list based on a stripped down version of the filepath
  set_names(nm = (basename(.) %>%
                    tools::file_path_sans_ext())) %>%
  purrr::map_dfr(read_csv, .id = "mod") %>% 
  mutate(mod = str_remove_all(mod, "\\.190428\\.aic_bic")) 


resid <-     
  list.files(
    here::here("data/derived_data/sommer/reduce_full"),
    pattern = "190428.resid.",
    full.names = TRUE
  ) %>% 
  # Name the elements of the list based on a stripped down version of the filepath
  set_names(nm = (basename(.) %>%
                    tools::file_path_sans_ext())) %>%
  purrr::map_dfr(read_csv, .id = "mod") %>% 
  mutate(mod = str_remove_all(mod, "\\.190428\\.resid")) 

```

# Variance components

* Summarize $h^2$ and $R$ estimated by each model

```{r}

varcomp %>% 
  filter(!is.na(effect)) %>% 
  select(mod, effect, var_comp) %>% 
#  reshape2::dcast(var_comp ~ effect)
  pivot_wider(names_from = effect,
              values_from = var_comp) %>% 
  mutate(h2 = (g)/(g + pe + te),
         R = (g+pe)/(g + pe + te))
  
  

```

# Model selection

```{r}
aic_bic %>%
  arrange(bic)
```


# Fixed effects

## Age

```{r}
# Line version
beta %>% 
  filter(str_detect(effect, "age"),
         mod == "full_fct_age") %>% 
  mutate(effect = str_remove(effect, "age"),
         effect = as.integer(effect)) %>% 
  add_row(effect = 1,
          estimate = 0) %>% 
  left_join(
    pheno %>% 
      group_by(age) %>% 
      tally() %>% 
      filter(!is.na(age)),
    by = c("effect" = "age")) %>% 
  filter(effect < 20) %>% 
  ggplot(aes(x = effect,
             y = estimate)) +
  geom_line() +
  geom_ribbon(aes(ymin = estimate - std_error,
                  ymax = estimate + std_error),
              alpha = 0.2,
              ) +
  scale_x_continuous(breaks = c(1:20)) +
  labs(x = "Age",
       y = "Effect estimate", 
       title = "Estimated effect of age on hair shedding score") 

cowplot::ggsave(here::here("figures/gen_pred/sommer/beta.age_line.png"), bg = "transparent", dpi = 500)

```

```{r, width = 14, height = 6}
# Bar plot

beta %>% 
  filter(str_detect(effect, "age"),
         mod == "full_fct_age") %>% 
  mutate(effect = str_remove(effect, "age"),
         effect = as.integer(effect)) %>% 
  add_row(effect = 1,
          estimate = 0) %>% 
  left_join(
    pheno %>% 
      group_by(age) %>% 
      tally() %>% 
      filter(!is.na(age)),
    by = c("effect" = "age")) %>% 
  filter(effect < 21) %>% 
  # https://stackoverflow.com/questions/54103496/using-a-different-color-for-only-the-selected-bar-in-geom-bar
  ggplot(aes(x = effect,
             y = estimate,
             fill = ifelse(effect == 2, "Highlighted", "Normal"))) +
  geom_bar(stat = "identity",
           position = "identity") +
  scale_fill_manual(name = "effect",
                     values = c("#e74a2f", "lightgrey")) +
  geom_errorbar(aes(ymin = estimate - std_error,
                  ymax = estimate + std_error)) +
  scale_x_continuous(breaks = c(1:18)) +
  theme_classic() +
  theme(
    text = element_text(family = "Glacial Indifference"),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_text(size = 20),
    legend.text = element_text(size = 16),
    axis.title.y = element_text(size = 24,
                                margin = margin(r = 15)),
    axis.title.x = element_text(size = 24,
                                margin = margin(t = 15)),
    legend.position = "none",
    plot.title = element_text(size = 22),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "transparent",
                                    colour = NA),
    plot.background = element_rect(fill = "transparent",
                                   colour = NA)
  ) +
  labs(x = "Age",
       y = "Effect estimate") 
       #title = str_wrap("Estimated effect of age on hair shedding score", width = 50))

cowplot::ggsave(here::here("figures/gen_pred/sommer/beta.age_bar.transp.png"), bg = "transparent", dpi = 500)
```


## GBLUP by breed

```{r, fig.width=14, fig.height=8}



blup %>% 
  filter(mod == "full_fct_age") %>% 
  left_join(pheno %>% 
              select(breed_code, international_id)) %>% 
  dplyr::filter(!breed_code %in% c("CROS", "CHIA") & !is.na(breed_code)) %>% 
  # group_by(breed_code) %>% 
  # mutate(n_breed = n()) %>% 
  mutate(type = 
           case_when(
             breed_code %in% c("SH", "ANR", "HFD", "AN") ~ "British",
             breed_code %in% c("SIM", "CHA", "GEL", "MAAN") ~ "Continental",
             breed_code %in% c("SIMB", "BG") ~ "American"
         )) %>%
  ggplot(aes(x = fct_reorder(breed_code, blup, median),
             y = blup)) +
             #fill = fct_reorder(breed_code, blup, median),)) +
    ggforce::geom_sina(aes(color = type),
                       alpha = 0.3,
                     #color = "#ff7436",
                     kernel = "rectangular"
                     ) +
  scale_color_manual(values = c("#126180",
                                "#e74a2f",
                                "#fedb11")) +
  geom_boxplot(aes(fill = type),
               alpha = 0.4,
               show.legend = FALSE) +
    scale_fill_manual(values = c("#126180",
                                "#e74a2f",
                                "#fedb11")) +
   theme_classic() +
  theme(
    text = element_text(family = "Glacial Indifference",
                        #color = "#EDEAE5"
                        ),
    plot.title = element_text(size = 28,
                              margin = margin(b = 15)),
    plot.subtitle = element_text(size = 22),
    axis.text.y = element_text(size = 24,
                               #color = "#EDEAE5"
                               ),
    axis.text.x = element_text(size = 24,
                              # color = "#EDEAE5"
                              ),
    legend.text = element_text(size = 22),
    legend.title = element_text(size = 24),
    axis.title.y = element_text(size = 28,
                                margin = margin(r = 15)),
    axis.title.x = element_text(size = 28,
                                margin = margin(t = 15)),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "transparent",
                                    colour = NA),
    plot.background = element_rect(fill = "transparent",
                                   colour = NA),
    legend.background = element_rect(fill = "transparent",
                                   colour = NA)
  ) +
  labs(x = "Breed code", 
       y = "GBLUP breeding value",
       color = "Breed type")
       #title = "Estimated genomic breeding values stratified by breed")

ggsave(here::here("figures/gen_pred/sommer/bv.breeds_box.transp.png"), bg = "transparent", dpi = 500)
```


```{r, fig.height=10, fig.width=14}
blup %>% 
  filter(mod == "full_fct_age") %>% 
  left_join(pheno %>% 
              mutate(international_id = as.character(international_id)) %>% 
              select(breed_code, international_id)) %>% 
  dplyr::filter(!breed_code %in% c("CROS", "CHIA") & !is.na(breed_code)) %>% 
  group_by(breed_code) %>% 
  mutate(n_breed = n()) %>% 
  ungroup() %>% 
  mutate(type = 
           case_when(
             breed_code %in% c("SH", "ANR", "HFD", "AN") ~ "British",
             breed_code %in% c("SIM", "CHA", "GEL", "MAAN") ~ "Continental",
             breed_code %in% c("SIMB", "BG") ~ "American"
         )) %>% 
  ggplot(aes(x = blup,
             y = fct_reorder(breed_code, blup, median),
                                    fill = type)) +
  # bakeoff::scale_fill_bakeoff(discrete = TRUE) +
  scale_fill_manual(values = c("#126180", "#", "#8e4866")) +
  ggridges::geom_density_ridges(alpha = 0.5) +
  theme(axis.title.y = element_text(size = 18),
        axis.title.x = element_text(size = 18),
        plot.title = element_text(size = 22),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        # legend.position = "none"
        ) +
  labs(y = "", 
       x = "GBLUP breeding value",
       fill = "Breed type",
       title = "Estimated genomic breeding values stratified by breed")
  
ggsave(here::here("figures/gen_pred/sommer/bv.breeds_ridges.png"), dpi = 500)

```


# Cross validation

## Assign groups and generate data

```{r}

# Split individuals into 3 groups

cv_groups <- 
  pheno %>% 
  cv_assign()
  

write_rds(cv_groups, here::here("data/derived_data/190502.cv_groups.rds"))
```

```{r}
pheno %>% 
  left_join(cv_groups) %>% 
  group_by(cv_group) %>% 
  tally()
```

```{r}

pheno %>% 
  left_join(cv_groups) %>% 
  write_rds(here::here("data/derived_data/pheno_cv.rds"))

```


## Correlation

```{r}

cv_blup <-
  list.files(
    here::here("data/derived_data/sommer/reduce_cv"),
    pattern = "190428.*.blup.",
    full.names = TRUE
  ) %>% 
  # Name the elements of the list based on a stripped down version of the filepath
  set_names(nm = (basename(.) %>%
                    tools::file_path_sans_ext())) %>%
  purrr::map_dfr(read_csv, .id = "mod") %>% 
  mutate(cv = str_extract(mod, "[1-3](?=\\.190428)"),
         mod = str_extract(mod, "[[:graph:]]+(?=_cv)")) %>% 
  rename(cv_blup = blup) %>% 
  # Add full model BLUP values
  left_join(
    blup %>% 
      # filter(mod == "full_fct_age") %>%
      # select(-mod) %>% 
      rename(full_blup = blup),
    by = c("mod", "international_id")) %>% 
  # One Hereford didn't make it into the full model for some reason
  filter(!is.na(full_blup))
  

```


```{r}

# Between each CV and the full model BLUPs
cv_blup %>% 
  group_by(mod, cv) %>% 
  summarise(cv_corr = cor(cv_blup, full_blup))




```

```{r}

cv_blup %>% 
  filter(mod == "reduced_fct_age") %>% 
  left_join(
    pheno %>% 
      select(breed_code, international_id) %>% 
      mutate(international_id = as.character(international_id)) %>% 
      distinct(),
    by = c("international_id")) %>% 
    # group_by(international_id) %>% 
  group_by(breed_code) %>% 
  summarise(cv_corr = cor(cv_blup, full_blup), 
            n = n_distinct(international_id)) %>% 
  arrange(desc(cv_corr))
```

# Validate breed values against adjusted phenotypes

```{r}

val_data <- 
  resid %>% 
  filter(mod == "reduced_fct_age") %>% 
  left_join(blup %>% 
      filter(mod == "reduced_fct_age")) %>% 
  mutate(international_id = as_factor(international_id)) %>% 
  rename(adj_hs = resid)


```

## Including individual as a random effect

```{r}
ran.val_mod <-
  nlme::lme(adj_hs ~ blup,
            random = ~ 1 | international_id,
           data = val_data)
```

```{r}
summary(ran.val_mod)

```

```{r, fig.width = 7, fig.height = 7}

broom::augment(ran.val_mod) %>%
  ggplot(aes(x = .fixed,
             y = adj_hs)) +
  geom_hex(aes(fill = stat(count)), bins = 40) +
  lims(x = c(-3, 4),
       y = c(-3, 4)) +
  viridis::scale_fill_viridis(option = "inferno",
                              direction = 1,
                              begin = .2) +
  geom_abline(slope = 1,
              size = 1,
              linetype = "twodash") +
    geom_abline(slope = 1.46,
              size = 1,
             # linetype = "twodash",
              color = "red") +
  theme_classic() +
  theme(
    text = element_text(family = "Glacial Indifference"),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    legend.text = element_text(size = 16),
    axis.title.y = element_text(size = 18,
                                margin = margin(r = 15)),
    axis.title.x = element_text(size = 18,
                                margin = margin(t = 15)),
    legend.title = element_text(size = 18),
    plot.title = element_text(size = 22),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "transparent",
                                    colour = NA),
    plot.background = element_rect(fill = "transparent",
                                   colour = NA),
    legend.background = element_rect(fill = "transparent",
                                   colour = NA)
  ) +
  labs(x = "Effect estimate (GBLUP value fit as fixed effect)",
       y = "Adjusted hair score (Y)",
       fill = "Count")
      # title = "Breeding value validation") 


ggsave(here::here("figures/gen_pred/sommer/bv.validation_hex.transp.png"), dpi = 500, bg = "transparent")
```

## No random effects


```{r}
noran.val_mod <- 
  lm(adj_hs ~ blup,
           data = val_data)


summary(noran.val_mod)
```

```{r}

pheno %>% 
  specify(hair_score ~ lat) %>% 
  generate(reps = 100, type = "bootstrap") %>%
  

```

# Weaning weight plot


```{r}

calf_report <-
read_excel(here::here("data/raw_data/180706.sim.Anm_CG_Data.xlsx"),
           guess_max = 6135) %>%
  janitor::clean_names() %>%
  rename(
    calf_sex = sex,
    calf_reg = anm_nbr,
    adj_ww = ad_j_ww,
    birth_dt = brth_dt
  ) %>%
  mutate(calf_sex =
           case_when(calf_sex == "C" ~ "F",
                     calf_sex %in% c("S", "B") ~ "M")) %>%
  select(calf_reg, calf_sex, adj_bw, birth_dt, adj_ww, w_dt, adj_yw, y_dt) %>% 
  mutate(wean_year = year(w_dt))

```


```{r}
dam_report <-
  read_excel(here::here("data/raw_data/180706.sim.Dam_Progeny_Report.xlsx")) %>% 
  janitor::clean_names() %>% 
  mutate_at(c("calf_dob", "wean_date"), as.Date) %>% 
  rename(dam_reg = dam_asa_number,
         calf_reg = calf_asa_number) %>% 
  mutate(wean_year = year(wean_date)) %>% 
  select(dam_reg, calf_reg, calf_dob:wean_year)
```

```{r}
ww_data <-
  calf_report %>% 
  filter(wean_year %in% c(2016, 2017, 2018) & adj_ww != 0) %>% 
  mutate(wean_year = as.character(wean_year)) %>% 
  left_join(dam_report %>% 
              select(dam_reg, calf_reg)) %>% 
  filter(!is.na(dam_reg)) %>% 
  left_join(long, by = c("dam_reg" = "registration_number",
                         "wean_year" = "year")) %>% 
    left_join(old_samp %>% 
              select(Lab_ID, international_id)) %>% 
  left_join(blup %>% 
              filter(mod == "full_fct_age")) %>% 
  mutate_at(c("farm_id", "calf_sex", "calving_season", "wean_year"), as_factor)

ww_data %>% 
  distinct(dam_reg)
```

```{r}
ww_mod <- 
  lm(adj_ww~1 +
     as_factor(calving_season) +
     as_factor(calf_sex) +
     as_factor(farm_id) +
     as_factor(wean_year),
   data = ww_data)


ww_mod_r <-
  lme4::lmer(adj_ww ~ 1 + calving_season + wean_year + calf_sex + (1|farm_id),
     data = ww_data)



summary(ww_mod)
summary(ww_mod_r)
```


```{r, fig.width= 14 , fig.height= 8}

ww_mod_r %>% 
  broom::augment_columns(ww_data) %>% 
  ggplot(aes(x = as.factor(hair_score),
             y = .resid)) +
  ggforce::geom_sina(alpha = 0.3,
                     color = "#ff7436",
                     kernel = "rectangular") +
  geom_boxplot(outlier.color = "#e74a2f",
               outlier.alpha = 0.7,
               alpha = 0.4,
               fill = "#ef8759") +
   theme_classic() +
  theme(
    text = element_text(family = "Glacial Indifference",
                        #color = "#EDEAE5"
                        ),
    plot.title = element_text(size = 24),
    plot.subtitle = element_text(size = 18, 
                                 margin = margin(b = 15)),
    axis.text.y = element_text(size = 24,
                               #color = "#EDEAE5"
                               ),
    axis.text.x = element_text(size = 24,
                              # color = "#EDEAE5"
                              ),
    legend.text = element_text(size = 22),
    axis.title.y = element_text(size = 28,
                                margin = margin(r = 15)),
    axis.title.x = element_text(size = 28,
                                margin = margin(t = 15)),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "transparent",
                                    colour = NA),
    plot.background = element_rect(fill = "transparent",
                                   colour = NA)
  ) +
  # n = 1,833
  labs(x = "Dam's unadjusted hair shedding score",
       y = str_wrap("Calf's weaning weight adjusted for sex + year + calving season + age at weaning",
                    width = 35))
       #title = str_wrap("Dams with lower hair shedding scores tend to wean heavier calves",
            #            width = 45),
       #subtitle = "(American Simmental Association 2016-2018 data; n = 1,833)")

ggsave(here::here("talks_articles/bog_19/bog_sim_ww.transp.png"), bg = "transparent", dpi = 500)
```

```{r}

blup_ww_mod <-lm(adj_ww ~ 1 + calving_season + wean_year + calf_sex + blup + farm_id,
     data = ww_data)
 
summary(blup_ww_mod)

blup_ww_mod %>% 
  broom::augment(ww_data)

```


```{r}
ww_mod_r %>% 
  broom::augment_columns(ww_data) %>% 
  ggplot(aes(x = blup,
             y = .resid)) +
  geom_hex(aes(fill = stat(count)), bins = 40) +
  viridis::scale_fill_viridis(option = "inferno",
                              direction = 1,
                              begin = .2) 
  
  
```

